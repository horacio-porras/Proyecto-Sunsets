<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago - Sunset's Tarbaca</title>
    <link rel="icon" type="image/png" href="/sunsets_logo_b.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .payment-method {
            transition: all 0.3s ease;
        }
        .payment-method:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .payment-method.selected {
            border-color: #f97316;
            background-color: #fff7ed;
        }
    </style>
    <script src="/js/auth.js"></script>
    <script src="/js/navbar.js"></script>
    <script src="/js/footer.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Navbar Container -->
    <div id="navbar-container"></div>

    <!-- Payment Process -->
    <section class="py-12 flex-grow">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
                <!-- Progress Steps -->
                <div class="mb-8">
                    <div class="flex items-center justify-center space-x-4">
                        <div class="flex items-center">
                            <div class="bg-gray-300 text-gray-600 w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold">1</div>
                            <span class="ml-2 text-sm font-semibold text-gray-600">Información</span>
                        </div>
                        <div class="w-16 h-1 bg-gradient-to-r from-orange-500 to-red-500"></div>
                        <div class="flex items-center">
                            <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold">2</div>
                            <span class="ml-2 text-sm font-semibold text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-500">Pago</span>
                        </div>
                        <div class="w-16 h-1 bg-gray-300"></div>
                        <div class="flex items-center">
                            <div class="bg-gray-300 text-gray-600 w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold">3</div>
                            <span class="ml-2 text-sm font-semibold text-gray-600">Confirmación</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Payment Methods -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Payment Methods Selection -->
                        <div class="bg-white rounded-lg shadow-md">
                            <div class="p-6 border-b border-gray-200">
                                <h2 class="text-xl font-semibold">Método de Pago</h2>
                                <p class="text-gray-600 mt-1">Selecciona tu método de pago preferido</p>
                            </div>
                            <div class="p-6">
                                <div class="space-y-4">
                                    <!-- Cash Payment -->
                                    <div class="payment-method border-2 border-gray-200 rounded-lg p-4 cursor-pointer" onclick="selectPaymentMethod('efectivo')">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                                <i class="fas fa-money-bill-wave text-green-600 text-xl"></i>
                                            </div>
                                            <div class="flex-1">
                                                <h3 class="font-semibold text-lg">Pago en Efectivo</h3>
                                                <p class="text-gray-600">Paga cuando recibas tu pedido</p>
                                            </div>
                                            <div class="w-6 h-6 border-2 border-gray-300 rounded-full payment-radio" data-method="efectivo"></div>
                                        </div>
                                    </div>

                                    <!-- Credit Card -->
                                    <div class="payment-method border-2 border-gray-200 rounded-lg p-4 cursor-pointer" onclick="selectPaymentMethod('tarjeta')">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                                <i class="fas fa-credit-card text-blue-600 text-xl"></i>
                                            </div>
                                            <div class="flex-1">
                                                <h3 class="font-semibold text-lg">Tarjeta de Crédito/Débito</h3>
                                                <p class="text-gray-600">Pago seguro con tarjeta</p>
                                            </div>
                                            <div class="w-6 h-6 border-2 border-gray-300 rounded-full payment-radio" data-method="tarjeta"></div>
                                        </div>
                                    </div>

                                    <!-- Bank Transfer -->
                                    <div class="payment-method border-2 border-gray-200 rounded-lg p-4 cursor-pointer" onclick="selectPaymentMethod('transferencia')">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                                <i class="fas fa-university text-purple-600 text-xl"></i>
                                            </div>
                                            <div class="flex-1">
                                                <h3 class="font-semibold text-lg">Transferencia Bancaria</h3>
                                                <p class="text-gray-600">Transferencia directa a nuestra cuenta</p>
                                            </div>
                                            <div class="w-6 h-6 border-2 border-gray-300 rounded-full payment-radio" data-method="transferencia"></div>
                                        </div>
                                    </div>

                                    <!-- Sinpe Móvil -->
                                    <div class="payment-method border-2 border-gray-200 rounded-lg p-4 cursor-pointer" onclick="selectPaymentMethod('sinpe')">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                                                <i class="fas fa-mobile-alt text-orange-600 text-xl"></i>
                                            </div>
                                            <div class="flex-1">
                                                <h3 class="font-semibold text-lg">SINPE Móvil</h3>
                                                <p class="text-gray-600">Pago rápido con SINPE Móvil</p>
                                            </div>
                                            <div class="w-6 h-6 border-2 border-gray-300 rounded-full payment-radio" data-method="sinpe"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Details (shown when card is selected) -->
                        <div id="card-details" class="bg-white rounded-lg shadow-md hidden">
                            <div class="p-6 border-b border-gray-200">
                                <h2 class="text-xl font-semibold">Información de Tarjeta</h2>
                            </div>
                            <div class="p-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Número de Tarjeta *</label>
                                        <input type="text" id="cardNumber" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="1234 5678 9012 3456" maxlength="19">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Vencimiento *</label>
                                        <input type="text" id="cardExpiry" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="MM/AA" maxlength="5">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">CVV *</label>
                                        <input type="text" id="cardCVV" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="123" maxlength="4">
                                    </div>
                                    
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre en la Tarjeta *</label>
                                        <input type="text" id="cardName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Nombre como aparece en la tarjeta">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bank Transfer Details -->
                        <div id="transfer-details" class="bg-white rounded-lg shadow-md hidden">
                            <div class="p-6 border-b border-gray-200">
                                <h2 class="text-xl font-semibold">Información de Transferencia</h2>
                            </div>
                            <div class="p-6">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                    <h3 class="font-semibold text-blue-800 mb-2">Datos Bancarios</h3>
                                    <div class="space-y-2 text-sm">
                                        <p><span class="font-semibold">Banco:</span> Banco Nacional de Costa Rica</p>
                                        <p><span class="font-semibold">Cuenta:</span> 200-01-123-456789</p>
                                        <p><span class="font-semibold">Beneficiario:</span> Sunset's Tarbaca S.A.</p>
                                        <p><span class="font-semibold">Cédula:</span> 3-101-123456</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Número de Comprobante *</label>
                                        <input type="text" id="transferReference" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Número de referencia de la transferencia">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Banco Emisor</label>
                                        <input type="text" id="transferBank" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Nombre del banco desde donde transfieres">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SINPE Móvil Details -->
                        <div id="sinpe-details" class="bg-white rounded-lg shadow-md hidden">
                            <div class="p-6 border-b border-gray-200">
                                <h2 class="text-xl font-semibold">Información SINPE Móvil</h2>
                            </div>
                            <div class="p-6">
                                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
                                    <h3 class="font-semibold text-orange-800 mb-2">Datos SINPE Móvil</h3>
                                    <div class="space-y-2 text-sm">
                                        <p><span class="font-semibold">Número:</span> 6171-4020</p>
                                        <p><span class="font-semibold">Nombre:</span> Sunset's Tarbaca</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Número de Comprobante SINPE *</label>
                                    <input type="text" id="sinpeReference" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Número de referencia del SINPE">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="space-y-6">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">Resumen del Pedido</h3>
                            
                            <div class="space-y-3" id="payment-order-summary">
                                <!-- El resumen del pedido se cargará dinámicamente aquí -->
                            </div>
                            
                            <div class="mt-6">
                                <button onclick="processPayment()" class="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white py-3 px-4 rounded-md hover:from-orange-600 hover:to-red-600 focus:outline-none focus:ring-2 focus:ring-orange-500 transition font-semibold flex items-center justify-center gap-2">
                                    <i class="fas fa-credit-card"></i>
                                    Procesar Pago
                                </button>
                            </div>
                        </div>


                        <!-- Help -->
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">¿Necesitas Ayuda?</h3>
                            
                            <div class="space-y-3">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-phone text-orange-600"></i>
                                    <div>
                                        <p class="font-semibold">Teléfono</p>
                                        <p class="text-sm text-gray-600">+506 6171-4020</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-envelope text-orange-600"></i>
                                    <div>
                                        <p class="font-semibold">Email</p>
                                        <p class="text-sm text-gray-600">sunsetstarbaca@gmail.com</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer Container -->
    <div id="footer-container" class="mt-auto"></div>

    <script>
        let selectedPaymentMethod = null;
        let orderData = null;

        //Carga los datos del pedido desde localStorage
        document.addEventListener('DOMContentLoaded', function() {
            loadOrderData();
            loadOrderSummary();
        });

        function loadOrderData() {
            const savedOrderData = localStorage.getItem('sunsets-order-data');
            if (savedOrderData) {
                orderData = JSON.parse(savedOrderData);
            } else {
                window.location.href = '/pedidos.html';
            }
        }

        //Carga el resumen del pedido
        function loadOrderSummary() {
            const summaryContainer = document.getElementById('payment-order-summary');
            if (!summaryContainer || !orderData) return;

            const subtotal = orderData.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const deliveryFee = 1500;
            const taxRate = 0.05;
            const taxes = subtotal * taxRate;
            const total = subtotal + deliveryFee + taxes;

            summaryContainer.innerHTML = '';

            orderData.items.forEach(item => {
                const itemRow = document.createElement('div');
                itemRow.className = 'flex justify-between';
                itemRow.innerHTML = `
                    <span class="text-gray-600">${item.name} x${item.quantity}</span>
                    <span>₡${(item.price * item.quantity).toLocaleString()}</span>
                `;
                summaryContainer.appendChild(itemRow);
            });

            const separator1 = document.createElement('hr');
            separator1.className = 'my-3';
            summaryContainer.appendChild(separator1);

            const subtotalRow = document.createElement('div');
            subtotalRow.className = 'flex justify-between';
            subtotalRow.innerHTML = `
                <span class="text-gray-600">Subtotal</span>
                <span>₡${subtotal.toLocaleString()}</span>
            `;
            summaryContainer.appendChild(subtotalRow);

            const deliveryRow = document.createElement('div');
            deliveryRow.className = 'flex justify-between';
            deliveryRow.innerHTML = `
                <span class="text-gray-600">Costo de entrega</span>
                <span>₡${deliveryFee.toLocaleString()}</span>
            `;
            summaryContainer.appendChild(deliveryRow);

            const taxRow = document.createElement('div');
            taxRow.className = 'flex justify-between';
            taxRow.innerHTML = `
                <span class="text-gray-600">Impuestos</span>
                <span>₡${Math.round(taxes).toLocaleString()}</span>
            `;
            summaryContainer.appendChild(taxRow);

            const separator2 = document.createElement('hr');
            separator2.className = 'my-3';
            summaryContainer.appendChild(separator2);

            const totalRow = document.createElement('div');
            totalRow.className = 'flex justify-between font-semibold text-lg';
            totalRow.innerHTML = `
                <span>Total</span>
                <span>₡${Math.round(total).toLocaleString()}</span>
            `;
            summaryContainer.appendChild(totalRow);
        }

        //Selecciona el método de pago
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            document.querySelectorAll('.payment-radio').forEach(el => {
                el.classList.remove('bg-orange-500', 'border-orange-500');
                el.classList.add('border-gray-300');
            });
            
            document.getElementById('card-details').classList.add('hidden');
            document.getElementById('transfer-details').classList.add('hidden');
            document.getElementById('sinpe-details').classList.add('hidden');
            
            const selectedElement = document.querySelector(`[data-method="${method}"]`).closest('.payment-method');
            selectedElement.classList.add('selected');
            
            const radio = selectedElement.querySelector('.payment-radio');
            radio.classList.remove('border-gray-300');
            radio.classList.add('bg-orange-500', 'border-orange-500');
            
            if (method === 'tarjeta') {
                document.getElementById('card-details').classList.remove('hidden');
            } else if (method === 'transferencia') {
                document.getElementById('transfer-details').classList.remove('hidden');
            } else if (method === 'sinpe') {
                document.getElementById('sinpe-details').classList.remove('hidden');
            }
        }

        //Valida el formulario de pago
        function validatePaymentForm() {
            if (!selectedPaymentMethod) {
                alert('Por favor selecciona un método de pago.');
                return false;
            }

            if (selectedPaymentMethod === 'tarjeta') {
                const cardNumber = document.getElementById('cardNumber').value.trim();
                const cardExpiry = document.getElementById('cardExpiry').value.trim();
                const cardCVV = document.getElementById('cardCVV').value.trim();
                const cardName = document.getElementById('cardName').value.trim();

                if (!cardNumber || !cardExpiry || !cardCVV || !cardName) {
                    alert('Por favor completa todos los campos de la tarjeta.');
                    return false;
                }

                if (cardNumber.replace(/\s/g, '').length < 13) {
                    alert('Por favor ingresa un número de tarjeta válido.');
                    return false;
                }

                if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
                    alert('Por favor ingresa una fecha de vencimiento válida (MM/AA).');
                    return false;
                }

                if (cardCVV.length < 3) {
                    alert('Por favor ingresa un CVV válido.');
                    return false;
                }
            } else if (selectedPaymentMethod === 'transferencia') {
                const transferReference = document.getElementById('transferReference').value.trim();
                if (!transferReference) {
                    alert('Por favor ingresa el número de comprobante de la transferencia.');
                    return false;
                }
            } else if (selectedPaymentMethod === 'sinpe') {
                const sinpeReference = document.getElementById('sinpeReference').value.trim();
                if (!sinpeReference) {
                    alert('Por favor ingresa el número de comprobante del SINPE.');
                    return false;
                }
            }

            return true;
        }

        //Procesa el pago
        function processPayment() {
            if (!validatePaymentForm()) {
                return;
            }

            const button = document.querySelector('button[onclick="processPayment()"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
            button.disabled = true;

            setTimeout(() => {
                const paymentData = {
                    method: selectedPaymentMethod,
                    timestamp: new Date().toISOString()
                };

                if (selectedPaymentMethod === 'tarjeta') {
                    paymentData.cardNumber = document.getElementById('cardNumber').value.trim();
                    paymentData.cardExpiry = document.getElementById('cardExpiry').value.trim();
                    paymentData.cardName = document.getElementById('cardName').value.trim();
                } else if (selectedPaymentMethod === 'transferencia') {
                    paymentData.transferReference = document.getElementById('transferReference').value.trim();
                    paymentData.transferBank = document.getElementById('transferBank').value.trim();
                } else if (selectedPaymentMethod === 'sinpe') {
                    paymentData.sinpeReference = document.getElementById('sinpeReference').value.trim();
                }

                const completeOrder = {
                    ...orderData,
                    payment: paymentData,
                    id: generateOrderId(),
                    status: 'confirmed',
                    timestamp: new Date().toISOString()
                };

                localStorage.setItem('sunsets-complete-order', JSON.stringify(completeOrder));
                localStorage.removeItem('sunsets-order-data');
                localStorage.removeItem('sunsets-cart');

                window.location.href = '/confirmacion.html';
            }, 2000);
        }

        //Genera un ID aleatorio para el pedido
        function generateOrderId() {
            return Math.floor(10000 + Math.random() * 90000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const cardNumberInput = document.getElementById('cardNumber');
            if (cardNumberInput) {
                cardNumberInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                    e.target.value = formattedValue;
                });
            }

            const cardExpiryInput = document.getElementById('cardExpiry');
            if (cardExpiryInput) {
                cardExpiryInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2, 4);
                    }
                    e.target.value = value;
                });
            }

            const cardCVVInput = document.getElementById('cardCVV');
            if (cardCVVInput) {
                cardCVVInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
            }
        });
    </script>
</body>
</html>
