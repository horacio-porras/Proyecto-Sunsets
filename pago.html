<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago - Sunset's Tarbaca</title>
    <link rel="icon" type="image/png" href="/sunsets_logo_b.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .payment-method {
            transition: all 0.3s ease;
        }
        .payment-method:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .payment-method.selected {
            transform: translateY(-2px);
        }
        .payment-method.selected[data-method="efectivo"] {
            border-color: #10b981;
        }
        .payment-method.selected[data-method="sinpe"] {
            border-color: #3b82f6;
        }
        .payment-method.selected[data-method="efectivo"] .payment-radio {
            border-color: #10b981;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .payment-method.selected[data-method="sinpe"] .payment-radio {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        .payment-method.selected .payment-radio::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .payment-method.selected[data-method="efectivo"] .payment-icon {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .payment-method.selected[data-method="sinpe"] .payment-icon {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        .payment-method.selected .payment-icon i {
            color: white;
        }
        .payment-method.selected[data-method="efectivo"] .payment-title {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .payment-method.selected[data-method="sinpe"] .payment-title {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .payment-method.selected[data-method="efectivo"] .payment-description {
            color: #059669;
        }
        .payment-method.selected[data-method="sinpe"] .payment-description {
            color: #2563eb;
        }
    </style>
    <script src="/js/auth.js"></script>
    <script src="/js/navbar.js"></script>
    <script src="/js/footer.js"></script>
    <script src="/js/orders.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Navbar Container -->
    <div id="navbar-container"></div>

    <!-- Payment Process -->
    <section class="py-12 flex-grow">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
                <!-- Progress Steps -->
                <div class="mb-8">
                    <div class="flex items-center justify-center space-x-4">
                        <div class="flex items-center">
                            <div class="bg-gray-300 text-gray-600 w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold">1</div>
                            <span class="ml-2 text-sm font-semibold text-gray-600">Información</span>
                        </div>
                        <div class="w-16 h-1 bg-gradient-to-r from-orange-500 to-red-500"></div>
                        <div class="flex items-center">
                            <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold">2</div>
                            <span class="ml-2 text-sm font-semibold text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-500">Pago</span>
                        </div>
                        <div class="w-16 h-1 bg-gray-300"></div>
                        <div class="flex items-center">
                            <div class="bg-gray-300 text-gray-600 w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold">3</div>
                            <span class="ml-2 text-sm font-semibold text-gray-600">Confirmación</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <!-- Payment Methods -->
                    <div class="lg:col-span-3 space-y-6">
                        <!-- Payment Methods Selection -->
                        <div class="bg-white rounded-lg shadow-md">
                            <div class="p-6 border-b border-gray-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                <div>
                                    <h2 class="text-xl font-semibold">Método de Pago</h2>
                                    <p class="text-gray-600 mt-1">Selecciona tu método de pago preferido</p>
                                </div>
                                <button onclick="goBackToOrder()" class="inline-flex items-center gap-2 bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-2 rounded-lg hover:from-orange-600 hover:to-red-600 transition font-semibold">
                                    <i class="fas fa-arrow-left"></i>
                                    Información
                                </button>
                            </div>
                            <div class="p-6">
                                <div class="space-y-4">
                                    <!-- Cash Payment -->
                                    <div class="payment-method border-2 border-gray-200 rounded-lg p-4 cursor-pointer" data-method="efectivo" onclick="selectPaymentMethod('efectivo')">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center transition-all duration-300 payment-icon" data-method="efectivo">
                                                <i class="fas fa-money-bill-wave text-green-600 text-xl"></i>
                                            </div>
                                            <div class="flex-1">
                                                <h3 class="font-semibold text-lg transition-colors duration-300 payment-title" data-method="efectivo">Pago en Efectivo</h3>
                                                <p class="text-gray-600 text-sm transition-colors duration-300 payment-description" data-method="efectivo">Paga cuando recibas tu pedido</p>
                                            </div>
                                            <div class="w-6 h-6 border-2 border-gray-300 rounded-full payment-radio relative" data-method="efectivo"></div>
                                        </div>
                                    </div>

                                    <!-- Sinpe Móvil -->
                                    <div class="payment-method border-2 border-gray-200 rounded-lg p-4 cursor-pointer" data-method="sinpe" onclick="selectPaymentMethod('sinpe')">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center transition-all duration-300 payment-icon" data-method="sinpe">
                                                <i class="fas fa-mobile-alt text-blue-600 text-xl"></i>
                                            </div>
                                            <div class="flex-1">
                                                <h3 class="font-semibold text-lg transition-colors duration-300 payment-title" data-method="sinpe">SINPE Móvil</h3>
                                                <p class="text-gray-600 text-sm transition-colors duration-300 payment-description" data-method="sinpe">Pago rápido con SINPE Móvil</p>
                                            </div>
                                            <div class="w-6 h-6 border-2 border-gray-300 rounded-full payment-radio relative" data-method="sinpe"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SINPE Móvil Details -->
                        <div id="sinpe-details" class="bg-white rounded-lg shadow-md hidden">
                            <div class="p-6 border-b border-gray-200">
                                <h2 class="text-xl font-semibold">Información SINPE Móvil</h2>
                            </div>
                            <div class="p-6">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                    <h3 class="font-semibold text-blue-800 mb-2">Datos SINPE Móvil</h3>
                                    <div class="space-y-2 text-sm">
                                        <p><span class="font-semibold">Número:</span> 6171-4020</p>
                                        <p><span class="font-semibold">Nombre:</span> Sunset's Tarbaca</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Número de Comprobante SINPE *</label>
                                    <input type="text" id="sinpeReference" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Número de referencia del SINPE">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">Resumen del Pedido</h3>
                            
                            <div class="space-y-3" id="payment-order-summary">
                                <!-- El resumen del pedido se cargará dinámicamente aquí -->
                            </div>
                            
                            <div class="mt-6">
                                <button onclick="processPayment()" class="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white py-3 px-4 rounded-md hover:from-orange-600 hover:to-red-600 focus:outline-none focus:ring-2 focus:ring-orange-500 transition font-semibold flex items-center justify-center gap-2">
                                    <i class="fas fa-lock"></i>
                                    Finalizar Pedido
                                </button>
                            </div>
                        </div>


                        <!-- Support Card -->
                    
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer Container -->
    <div id="footer-container" class="mt-auto"></div>

    <script>
        // Función helper para formatear precios con 2 decimales
        function formatPrice(price) {
            return parseFloat(price || 0).toLocaleString('es-CR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        let selectedPaymentMethod = null;
        let orderData = null;
        // Las variables activePromotions, promotionsLoaded, etc. están en orders.js
        const TAX_RATE = 0.13;
 
        //Carga los datos del pedido desde localStorage
        document.addEventListener('DOMContentLoaded', async function() {
            // Inicializar campo SINPE
            const sinpeReferenceInput = document.getElementById('sinpeReference');
            if (sinpeReferenceInput) {
                sinpeReferenceInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
            }

            loadOrderData();
            
            // Esperar a que orders.js se cargue completamente
            let retries = 0;
            while (typeof window.renderOrderSummaryHTML !== 'function' && retries < 30) {
                await new Promise(resolve => setTimeout(resolve, 100));
                retries++;
            }
            
            if (typeof window.renderOrderSummaryHTML === 'function') {
                await loadOrderSummary().catch(error => {
                    console.error('Error al cargar resumen de pago:', error);
                    const summaryContainer = document.getElementById('payment-order-summary');
                    if (summaryContainer && orderData) {
                        renderFallbackSummary(summaryContainer, orderData);
                    }
                });
            } else {
                console.error('renderOrderSummaryHTML no disponible después de esperar');
                const summaryContainer = document.getElementById('payment-order-summary');
                if (summaryContainer && orderData) {
                    renderFallbackSummary(summaryContainer, orderData);
                }
            }
        });
 
        window.goBackToOrder = function() {
            const referrer = document.referrer || '';

            if (referrer.includes('/cliente/pedidos')) {
                window.location.href = '/cliente/pedidos.html';
                return;
            }

            if (referrer.includes('/pedidos.html')) {
                window.location.href = '/pedidos.html';
                return;
            }

            try {
                const storedUserData = localStorage.getItem('userData');
                const userData = storedUserData ? JSON.parse(storedUserData) : null;
                const isClient = userData?.tipoUsuario === 'Cliente';
                const hasAuthToken = Boolean(localStorage.getItem('authToken'));

                if (isClient && hasAuthToken) {
                    window.location.href = '/cliente/pedidos.html';
                    return;
                }
            } catch (error) {
                console.warn('No se pudo determinar el tipo de usuario para regresar al pedido:', error);
            }

            window.location.href = '/pedidos.html';
        }
 
         function loadOrderData() {
             const savedOrderData = localStorage.getItem('sunsets-order-data') || localStorage.getItem('pendingOrder');
             if (savedOrderData) {
                 orderData = JSON.parse(savedOrderData);
             } else {
                 window.location.href = '/pedidos.html';
             }
         }
 
        async function loadOrderSummary() {
            if (!orderData || !orderData.items) {
                console.error('No hay datos del pedido');
                const summaryContainer = document.getElementById('payment-order-summary');
                if (summaryContainer) {
                    summaryContainer.innerHTML = '<p class="text-red-500">No hay datos del pedido disponibles</p>';
                }
                return;
            }

            const summaryContainer = document.getElementById('payment-order-summary');
            if (!summaryContainer) {
                console.error('Container payment-order-summary no encontrado');
                return;
            }

            try {
                // Esperar a que orders.js esté completamente cargado
                let retries = 0;
                const maxRetries = 20;
                while (typeof window.renderOrderSummaryHTML !== 'function' && retries < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                }

                if (typeof window.renderOrderSummaryHTML !== 'function') {
                    console.warn('renderOrderSummaryHTML no está disponible, usando fallback');
                    renderFallbackSummary(summaryContainer, orderData);
                    return;
                }

                const items = Array.isArray(orderData.items) ? orderData.items : [];
                if (items.length === 0) {
                    console.error('No hay items en el pedido');
                    summaryContainer.innerHTML = '<p class="text-red-500">No hay productos en el pedido</p>';
                    return;
                }

                const deliveryFee = Number(orderData.deliveryFee) || 1500;
                let rewardCanje = orderData.rewardCanje || orderData.reward;
                const rewardName = rewardCanje?.nombre || orderData.reward?.nombre || 'por puntos';

                // Asegurar que rewardCanje tenga tipo_promocion si solo tiene tipo
                if (rewardCanje && rewardCanje.tipo && !rewardCanje.tipo_promocion) {
                    rewardCanje = {
                        ...rewardCanje,
                        tipo_promocion: rewardCanje.tipo
                    };
                }

                // NO calcular rewardDiscount aquí - dejar que renderOrderSummaryHTML lo calcule correctamente
                // Pasamos activeReward en options para que renderOrderSummaryHTML pueda calcular correctamente
                // según el tipo (porcentaje o fijo)
                console.log('Llamando a renderOrderSummaryHTML con', items.length, 'items');
                const totals = await window.renderOrderSummaryHTML(items, 'payment-order-summary', {
                    deliveryFee: deliveryFee,
                    rewardDiscount: undefined, // No pasar rewardDiscount calculado, dejar que se calcule
                    rewardName: rewardName,
                    activeReward: rewardCanje, // Pasar el objeto completo para que pueda verificar el tipo
                    taxRate: 0.13
                });

                if (totals) {
                    Object.assign(orderData, totals);
                    console.log('Resumen del pedido actualizado correctamente');
                } else {
                    console.warn('renderOrderSummaryHTML retornó null, usando fallback');
                    renderFallbackSummary(summaryContainer, orderData);
                }
            } catch (error) {
                console.error('Error al calcular el resumen del pedido:', error);
                console.error('Stack:', error.stack);
                if (summaryContainer && orderData) {
                    renderFallbackSummary(summaryContainer, orderData);
                }
            }
        }
 
        // Las funciones normalizePromotion, loadActivePromotions y calculatePromotionsDiscount
        // están definidas en orders.js y se usan desde allí

        async function computeFinancialBreakdown(order) {
             const items = Array.isArray(order.items) ? order.items : [];
             const subtotalFallback = items.reduce((sum, item) => {
                 const price = Number(item.price) || 0;
                 const quantity = Number(item.quantity) || 0;
                 return sum + price * quantity;
             }, 0);
 
            const subtotalRaw = Number(order.subtotal);
            const subtotal = Number.isFinite(subtotalRaw) && subtotalRaw > 0 ? subtotalRaw : subtotalFallback;

            const storedPromotionDiscount = Number(order.promotionDiscount);
            let promotionDiscount = Number.isFinite(storedPromotionDiscount) && storedPromotionDiscount > 0
                ? storedPromotionDiscount
                : 0;

            let promotionsApplied = Array.isArray(order.promotionsApplied)
                ? order.promotionsApplied.map(promo => ({
                    label: promo.label || promo.nombre || 'Descuento',
                    amount: Number(promo.amount) || Number(promo.valor) || 0,
                    alcance: promo.alcance || 'general'
                })).filter(promo => promo.amount > 0)
                : [];

            const hasStoredPromotions = promotionsApplied.length > 0;
            if (hasStoredPromotions && promotionDiscount <= 0) {
                promotionDiscount = promotionsApplied.reduce((sum, promo) => sum + (promo.amount || 0), 0);
            }

            let subtotalAfterPromotions = Number(order.subtotalAfterPromotions);
            if (!Number.isFinite(subtotalAfterPromotions) || subtotalAfterPromotions <= 0) {
                subtotalAfterPromotions = Math.max(0, subtotal - promotionDiscount);
            }

            if (!hasStoredPromotions && promotionDiscount <= 0) {
                // Usar las funciones de orders.js si están disponibles
                if (typeof window.loadActivePromotions === 'function' && typeof window.calculatePromotionsDiscount === 'function') {
                    const promotions = await window.loadActivePromotions();
                    const { discount, breakdown } = window.calculatePromotionsDiscount(subtotal, items, promotions);
                    promotionDiscount = discount;
                    promotionsApplied = breakdown;
                    subtotalAfterPromotions = Math.max(0, subtotal - promotionDiscount);
                }
            }

            let deliveryFee = Number(order.deliveryFee);
            if (!Number.isFinite(deliveryFee)) {
                const deliveryFeeFromDelivery = Number(order.delivery?.fee);
                deliveryFee = Number.isFinite(deliveryFeeFromDelivery) ? deliveryFeeFromDelivery : deliveryFee >= 0 ? deliveryFee : 1500;
            }
            if (!Number.isFinite(deliveryFee) || deliveryFee < 0) {
                deliveryFee = 1500;
            }

            // Calcular descuento de recompensa ANTES de calcular impuestos (igual que orders.js)
            let rewardDiscount = 0;
            const rewardCanje = order.rewardCanje || order.reward;
            
            if (rewardCanje && rewardCanje.valor_canje) {
                // Siempre verificar el tipo de recompensa para calcular correctamente
                // Verificar tanto tipo como tipo_promocion
                const rewardType = rewardCanje.tipo_promocion || rewardCanje.tipo;
                if (rewardType === 'descuento_porcentaje') {
                    // Para porcentajes, calcular sobre subtotalAfterPromotions (antes de impuestos)
                    const porcentaje = Number(rewardCanje.valor_canje) / 100;
                    rewardDiscount = subtotalAfterPromotions * porcentaje;
                } else {
                    // Para descuentos fijos, usar el valor directamente pero limitado al subtotal
                    const rewardDiscountRaw = Number(order.rewardDiscount);
                    if (Number.isFinite(rewardDiscountRaw) && rewardDiscountRaw > 0) {
                        rewardDiscount = rewardDiscountRaw;
                    } else {
                        rewardDiscount = Math.min(Number(rewardCanje.valor_canje), subtotalAfterPromotions);
                    }
                }
            } else {
                // Fallback: si no hay rewardCanje pero hay rewardDiscount, usarlo directamente
                const rewardDiscountRaw = Number(order.rewardDiscount);
                if (Number.isFinite(rewardDiscountRaw) && rewardDiscountRaw > 0) {
                    rewardDiscount = rewardDiscountRaw;
                }
            }

            // Calcular subtotal después de aplicar el descuento de recompensa
            const subtotalAfterReward = Math.max(0, subtotalAfterPromotions - rewardDiscount);

            // Calcular impuestos sobre el subtotal DESPUÉS de aplicar el descuento de recompensa
            const computedTaxes = subtotalAfterReward * TAX_RATE;
            let taxes = Number(order.taxes);
            if (!Number.isFinite(taxes) || taxes < 0) {
                taxes = computedTaxes;
            }
            if (Math.abs(taxes - computedTaxes) > 0.5) {
                taxes = computedTaxes;
            }

            const loyaltyDiscountRaw = Number(order.loyaltyDiscount);
            const loyaltyDiscount = Number.isFinite(loyaltyDiscountRaw) && loyaltyDiscountRaw > 0
                ? loyaltyDiscountRaw
                : 0;

            // Calcular el total: subtotal después de recompensa + deliveryFee + taxes
            const computedTotal = Math.max(0, subtotalAfterReward + deliveryFee + taxes - loyaltyDiscount);
            let total = Number(order.total);
            if (!Number.isFinite(total) || Math.abs(total - computedTotal) > 0.5) {
                total = computedTotal;
            }
 
            return {
                items,
                subtotal,
                subtotalAfterPromotions,
                promotionDiscount,
                promotionsLines: promotionsApplied,
                deliveryFee,
                taxes,
                rewardDiscount,
                loyaltyDiscount,
                totalBeforeRewards,
                total
            };
        }

        //Selecciona el método de pago
        window.selectPaymentMethod = function(method) {
            selectedPaymentMethod = method;
            
            // Remover selección de todos los métodos
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Resetear todos los radios
            document.querySelectorAll('.payment-radio').forEach(el => {
                el.style.borderColor = '';
                el.style.background = '';
            });
 
            // Ocultar detalles de SINPE
            const sinpeDetails = document.getElementById('sinpe-details');
            if (sinpeDetails) {
                sinpeDetails.classList.add('hidden');
            }
 
            // Seleccionar el método elegido
            const selectedElement = document.querySelector(`[data-method="${method}"]`).closest('.payment-method');
            if (selectedElement) {
                selectedElement.classList.add('selected');
                
                const radio = selectedElement.querySelector('.payment-radio');
                if (radio) {
                    // Usar color azul para SINPE, verde para efectivo
                    radio.style.borderColor = method === 'sinpe' ? '#3b82f6' : '#10b981';
                }
            }
 
            // Mostrar detalles de SINPE si es el método seleccionado
            if (method === 'sinpe' && sinpeDetails) {
                sinpeDetails.classList.remove('hidden');
            }
        }

        //Valida el formulario de pago
        function validatePaymentForm() {
             if (!selectedPaymentMethod) {
                 alert('Por favor selecciona un método de pago.');
                 return false;
             }
 
            if (selectedPaymentMethod === 'sinpe') {
                const sinpeReference = document.getElementById('sinpeReference').value.trim();
                if (!sinpeReference) {
                    alert('Por favor ingresa el número de comprobante del SINPE.');
                    return false;
                }
            }
 
             return true;
         }

        //Procesa el pago
        window.processPayment = async function() {
            if (!validatePaymentForm()) {
                return;
            }

            const button = document.querySelector('button[onclick="processPayment()"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
            button.disabled = true;

            try {
                const paymentData = {
                    method: selectedPaymentMethod,
                    timestamp: new Date().toISOString()
                };

                if (selectedPaymentMethod === 'sinpe') {
                    paymentData.sinpeReference = document.getElementById('sinpeReference').value.trim();
                }

                // Usar los totales que ya se calcularon en loadOrderSummary
                // Si no están disponibles, calcularlos usando la función de orders.js
                let breakdown = null;
                if (orderData.subtotal && orderData.total) {
                    breakdown = {
                        subtotal: orderData.subtotal,
                        subtotalAfterPromotions: orderData.subtotalAfterPromotions || orderData.subtotal,
                        promotionDiscount: orderData.promotionDiscount || 0,
                        promotionsLines: orderData.promotionsApplied || [],
                        deliveryFee: orderData.deliveryFee || 1500,
                        taxes: orderData.taxes || 0,
                        rewardDiscount: orderData.rewardDiscount || 0,
                        loyaltyDiscount: orderData.loyaltyDiscount || 0,
                        totalBeforeRewards: orderData.totalBeforeRewards || orderData.total,
                        total: orderData.total
                    };
                } else {
                    // Fallback: calcular manualmente si no hay datos
                    try {
                        breakdown = await computeFinancialBreakdown(orderData);
                    } catch (calcError) {
                        console.error('No se pudo recalcular totales antes de enviar el pedido:', calcError);
                    }
                }

                const effectiveTotals = breakdown ? {
                    subtotal: breakdown.subtotal,
                    subtotalAfterPromotions: breakdown.subtotalAfterPromotions,
                    promotionDiscount: breakdown.promotionDiscount,
                    promotionsApplied: breakdown.promotionsLines,
                    deliveryFee: breakdown.deliveryFee,
                    taxes: breakdown.taxes,
                    rewardDiscount: breakdown.rewardDiscount,
                    loyaltyDiscount: breakdown.loyaltyDiscount,
                    totalBeforeRewards: breakdown.totalBeforeRewards,
                    total: breakdown.total
                } : {
                    subtotal: orderData.subtotal || 0,
                    subtotalAfterPromotions: orderData.subtotalAfterPromotions || orderData.subtotal || 0,
                    promotionDiscount: orderData.promotionDiscount || 0,
                    promotionsApplied: orderData.promotionsApplied || [],
                    deliveryFee: orderData.deliveryFee || 1500,
                    taxes: orderData.taxes || ((orderData.subtotalAfterPromotions || orderData.subtotal || 0) * TAX_RATE),
                    rewardDiscount: orderData.rewardDiscount || 0,
                    loyaltyDiscount: orderData.loyaltyDiscount || 0,
                    totalBeforeRewards: orderData.totalBeforeRewards || ((orderData.subtotalAfterPromotions || orderData.subtotal || 0) + (orderData.deliveryFee || 1500) + (orderData.taxes || ((orderData.subtotalAfterPromotions || orderData.subtotal || 0) * TAX_RATE))),
                    total: orderData.total || 0
                };

                //Prepara los datos del pedido para enviar al backend
                const orderPayload = {
                    items: orderData.items,
                    customer: orderData.customer,
                    delivery: orderData.delivery,
                    payment: paymentData,
                    subtotal: effectiveTotals.subtotal,
                    subtotalAfterPromotions: effectiveTotals.subtotalAfterPromotions,
                    deliveryFee: effectiveTotals.deliveryFee,
                    taxes: effectiveTotals.taxes,
                    promotionDiscount: effectiveTotals.promotionDiscount,
                    promotionsApplied: effectiveTotals.promotionsApplied,
                    total: effectiveTotals.total,
                    loyaltyDiscount: effectiveTotals.loyaltyDiscount,
                    totalBeforeRewards: effectiveTotals.totalBeforeRewards,
                    totalBeforeLoyalty: orderData.totalBeforeLoyalty,
                    loyaltyPointsUsed: 0
                };

                if (orderData.rewardCanje && orderData.rewardCanje.id_canje) {
                    orderPayload.rewardCanjeId = orderData.rewardCanje.id_canje;
                    orderPayload.rewardDiscount = effectiveTotals.rewardDiscount || orderData.rewardCanje.valor_canje || 0;
                }

                //Envía el pedido al backend
                const authToken = localStorage.getItem('authToken');
                const isAuthenticated = authToken && authToken !== 'null' && authToken !== '';
                
                //Usar endpoint diferente según si el usuario está autenticado o es invitado
                const endpoint = isAuthenticated ? '/api/pedidos' : '/api/pedidos/guest';
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                //Solo agregar Authorization header si el usuario está autenticado
                if (isAuthenticated) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(orderPayload)
                });

                const result = await response.json();

                if (result.success) {
                    const completeOrder = {
                        ...orderData,
                        payment: paymentData,
                        id: result.data.pedidoId,
                        numeroPedido: result.data.numeroPedido,
                        status: 'confirmed',
                        timestamp: new Date().toISOString()
                    };

                    localStorage.setItem('sunsets-complete-order', JSON.stringify(completeOrder));
                    localStorage.removeItem('sunsets-order-data');
                    localStorage.removeItem('pendingOrder');
                    localStorage.removeItem('sunsets-cart');
                    localStorage.removeItem('sunsets-active-reward');

                    window.location.href = '/confirmacion.html';
                } else {
                    throw new Error(result.message || 'Error al procesar el pedido');
                }

            } catch (error) {
                console.error('Error al procesar pago:', error);
                alert('Error al procesar el pedido: ' + error.message);
                
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        //Genera un ID aleatorio para el pedido
        function generateOrderId() {
            return Math.floor(10000 + Math.random() * 90000);
        }

        function getPaymentMethodName(method) {
             const methods = {
                 'efectivo': 'Pago en Efectivo',
                 'sinpe': 'SINPE Móvil'
             };
             return methods[method] || method;
         }

        function renderPromotionsBreakdown(order, promotionDiscountOverride) {
            const promotions = Array.isArray(order.promotionsApplied) ? order.promotionsApplied : (order.promotionsApplied || []);
            const promotionDiscount = Number(promotionDiscountOverride ?? order.promotionDiscount) || 0;

            if ((!Array.isArray(promotions) || promotions.length === 0) && promotionDiscount <= 0) {
                return '';
            }

            const lines = [];

            if (Array.isArray(promotions) && promotions.length > 0) {
                promotions.forEach((promo) => {
                    if (!promo) return;
                    const label = promo.label || 'Descuento';
                    const amount = Number(promo.amount) || 0;
                    if (amount <= 0) return;
                    lines.push(`
                        <div class="flex justify-between text-green-600 font-semibold">
                            <span>${label}</span>
                            <span>-₡${formatPrice(amount)}</span>
                        </div>
                    `);
                });
            } else if (promotionDiscount > 0) {
                lines.push(`
                    <div class="flex justify-between text-green-600 font-semibold">
                        <span>Descuento promocional</span>
                        <span>-₡${formatPrice(promotionDiscount)}</span>
                    </div>
                `);
            }

            return lines.join('');
        }

        function renderRewardsLoyaltyBreakdown(order, rewardDiscountOverride, loyaltyDiscountOverride) {
            const lines = [];
            const rewardDiscount = Number(rewardDiscountOverride ?? order.rewardDiscount) || 0;
            const loyaltyDiscount = Number(loyaltyDiscountOverride ?? order.loyaltyDiscount) || 0;

            if (rewardDiscount > 0) {
                lines.push(`
                    <div class="flex justify-between text-green-600 font-semibold">
                        <span>Descuento por recompensa</span>
                        <span>-₡${formatPrice(rewardDiscount)}</span>
                    </div>
                `);
            }

            if (loyaltyDiscount > 0) {
                lines.push(`
                    <div class="flex justify-between text-green-600 font-semibold">
                        <span>Descuento por puntos de lealtad</span>
                        <span>-₡${formatPrice(loyaltyDiscount)}</span>
                    </div>
                `);
            }

            return lines.join('');
        }

        function renderFallbackSummary(container, order) {
            const items = Array.isArray(order.items) ? order.items : [];
            const subtotal = items.reduce((sum, item) => sum + ((Number(item.price) || 0) * (Number(item.quantity) || 0)), 0);
            const promotionDiscount = Math.max(0, Number(order.promotionDiscount) || 0);
            const subtotalAfterPromotions = Math.max(0, subtotal - promotionDiscount);
            const deliveryFee = Number(order.deliveryFee) || 1500;
            const taxes = subtotalAfterPromotions * TAX_RATE;
            const rewardDiscount = Number(order.rewardDiscount) || 0;
            const loyaltyDiscount = Number(order.loyaltyDiscount) || 0;
            const total = Math.max(0, subtotalAfterPromotions + deliveryFee + taxes - rewardDiscount - loyaltyDiscount);

            container.innerHTML = '';

            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'flex justify-between';
                row.innerHTML = `
                    <span class="text-gray-600">${item.name} x${item.quantity}</span>
                    <span>₡${formatPrice(item.price * item.quantity)}</span>
                `;
                container.appendChild(row);
            });

            const separator1 = document.createElement('hr');
            separator1.className = 'my-3';
            container.appendChild(separator1);

            container.insertAdjacentHTML('beforeend', `
                <div class="flex justify-between">
                    <span class="text-gray-600">Subtotal</span>
                    <span>₡${formatPrice(subtotal)}</span>
                </div>
            `);

            container.insertAdjacentHTML('beforeend', `
                <div class="flex justify-between">
                    <span class="text-gray-600">Costo de entrega</span>
                    <span>₡${formatPrice(deliveryFee)}</span>
                </div>
            `);

            container.insertAdjacentHTML('beforeend', `
                <div class="flex justify-between">
                    <span class="text-gray-600">Impuestos</span>
                    <span>₡${formatPrice(taxes)}</span>
                </div>
            `);

            if (rewardDiscount > 0) {
                container.insertAdjacentHTML('beforeend', `
                    <div class="flex justify-between text-green-600 font-semibold">
                        <span>Descuento por recompensa</span>
                        <span>-₡${formatPrice(rewardDiscount)}</span>
                    </div>
                `);
            }

            if (loyaltyDiscount > 0) {
                container.insertAdjacentHTML('beforeend', `
                    <div class="flex justify-between text-green-600 font-semibold">
                        <span>Descuento por puntos de lealtad</span>
                        <span>-₡${formatPrice(loyaltyDiscount)}</span>
                    </div>
                `);
            }

            const separator2 = document.createElement('hr');
            separator2.className = 'my-3';
            container.appendChild(separator2);

            container.insertAdjacentHTML('beforeend', `
                <div class="flex justify-between font-semibold text-lg">
                    <span>Total</span>
                    <span>₡${formatPrice(total)}</span>
                </div>
            `);
        }

        // Inicializar campo SINPE (ya se maneja en el DOMContentLoaded principal)
        // Mover la lógica aquí para evitar duplicados

    </script>
</body>
</html>
