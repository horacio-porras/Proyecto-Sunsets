<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago - Sunset's Tarbaca</title>
    <link rel="icon" type="image/png" href="/sunsets_logo_b.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .payment-method {
            transition: all 0.3s ease;
        }
        .payment-method:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .payment-method.selected {
            border-color: #f97316;
            background-color: #fff7ed;
        }
    </style>
    <script src="/js/auth.js"></script>
    <script src="/js/navbar.js"></script>
    <script src="/js/footer.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Navbar Container -->
    <div id="navbar-container"></div>

    <!-- Payment Process -->
    <section class="py-12 flex-grow">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
                <!-- Progress Steps -->
                <div class="mb-8">
                    <div class="flex items-center justify-center space-x-4">
                        <div class="flex items-center">
                            <div class="bg-gray-300 text-gray-600 w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold">1</div>
                            <span class="ml-2 text-sm font-semibold text-gray-600">Información</span>
                        </div>
                        <div class="w-16 h-1 bg-gradient-to-r from-orange-500 to-red-500"></div>
                        <div class="flex items-center">
                            <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold">2</div>
                            <span class="ml-2 text-sm font-semibold text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-500">Pago</span>
                        </div>
                        <div class="w-16 h-1 bg-gray-300"></div>
                        <div class="flex items-center">
                            <div class="bg-gray-300 text-gray-600 w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold">3</div>
                            <span class="ml-2 text-sm font-semibold text-gray-600">Confirmación</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Payment Methods -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Payment Methods Selection -->
                        <div class="bg-white rounded-lg shadow-md">
                            <div class="p-6 border-b border-gray-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                <div>
                                    <h2 class="text-xl font-semibold">Método de Pago</h2>
                                    <p class="text-gray-600 mt-1">Selecciona tu método de pago preferido</p>
                                </div>
                                <button onclick="goBackToOrder()" class="inline-flex items-center gap-2 bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-2 rounded-lg hover:from-orange-600 hover:to-red-600 transition font-semibold">
                                    <i class="fas fa-arrow-left"></i>
                                    Regresar al Pedido
                                </button>
                            </div>
                            <div class="p-6">
                                <div class="space-y-4">
                                    <!-- Cash Payment -->
                                    <div class="payment-method border-2 border-gray-200 rounded-lg p-4 cursor-pointer" onclick="selectPaymentMethod('efectivo')">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                                <i class="fas fa-money-bill-wave text-green-600 text-xl"></i>
                                            </div>
                                            <div class="flex-1">
                                                <h3 class="font-semibold text-lg">Pago en Efectivo</h3>
                                                <p class="text-gray-600">Paga cuando recibas tu pedido</p>
                                            </div>
                                            <div class="w-6 h-6 border-2 border-gray-300 rounded-full payment-radio" data-method="efectivo"></div>
                                        </div>
                                    </div>

                                    <!-- Sinpe Móvil -->
                                    <div class="payment-method border-2 border-gray-200 rounded-lg p-4 cursor-pointer" onclick="selectPaymentMethod('sinpe')">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                                                <i class="fas fa-mobile-alt text-orange-600 text-xl"></i>
                                            </div>
                                            <div class="flex-1">
                                                <h3 class="font-semibold text-lg">SINPE Móvil</h3>
                                                <p class="text-gray-600">Pago rápido con SINPE Móvil</p>
                                            </div>
                                            <div class="w-6 h-6 border-2 border-gray-300 rounded-full payment-radio" data-method="sinpe"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SINPE Móvil Details -->
                        <div id="sinpe-details" class="bg-white rounded-lg shadow-md hidden">
                            <div class="p-6 border-b border-gray-200">
                                <h2 class="text-xl font-semibold">Información SINPE Móvil</h2>
                            </div>
                            <div class="p-6">
                                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
                                    <h3 class="font-semibold text-orange-800 mb-2">Datos SINPE Móvil</h3>
                                    <div class="space-y-2 text-sm">
                                        <p><span class="font-semibold">Número:</span> 6171-4020</p>
                                        <p><span class="font-semibold">Nombre:</span> Sunset's Tarbaca</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Número de Comprobante SINPE *</label>
                                    <input type="text" id="sinpeReference" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Número de referencia del SINPE">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="space-y-6">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">Resumen del Pedido</h3>
                            
                            <div class="space-y-3" id="payment-order-summary">
                                <!-- El resumen del pedido se cargará dinámicamente aquí -->
                            </div>
                            
                            <div class="mt-6">
                                <button onclick="processPayment()" class="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white py-3 px-4 rounded-md hover:from-orange-600 hover:to-red-600 focus:outline-none focus:ring-2 focus:ring-orange-500 transition font-semibold flex items-center justify-center gap-2">
                                    <i class="fas fa-lock"></i>
                                    Finalizar Pedido
                                </button>
                            </div>
                        </div>


                        <!-- Support Card -->
                    
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer Container -->
    <div id="footer-container" class="mt-auto"></div>

    <script>
        let selectedPaymentMethod = null;
        let orderData = null;
        let activePromotions = [];
        let promotionsLoaded = false;
        let promotionsLoadingPromise = null;
        const TAX_RATE = 0.05;
 
        //Carga los datos del pedido desde localStorage
        document.addEventListener('DOMContentLoaded', function() {
            loadOrderData();
            loadOrderSummary().catch(error => console.error('Error al cargar resumen de pago:', error));
        });
 
        function goBackToOrder() {
            const referrer = document.referrer || '';

            if (referrer.includes('/cliente/pedidos')) {
                window.location.href = '/cliente/pedidos.html';
                return;
            }

            if (referrer.includes('/pedidos.html')) {
                window.location.href = '/pedidos.html';
                return;
            }

            try {
                const storedUserData = localStorage.getItem('userData');
                const userData = storedUserData ? JSON.parse(storedUserData) : null;
                const isClient = userData?.tipoUsuario === 'Cliente';
                const hasAuthToken = Boolean(localStorage.getItem('authToken'));

                if (isClient && hasAuthToken) {
                    window.location.href = '/cliente/pedidos.html';
                    return;
                }
            } catch (error) {
                console.warn('No se pudo determinar el tipo de usuario para regresar al pedido:', error);
            }

            window.location.href = '/pedidos.html';
        }
 
         function loadOrderData() {
             const savedOrderData = localStorage.getItem('sunsets-order-data') || localStorage.getItem('pendingOrder');
             if (savedOrderData) {
                 orderData = JSON.parse(savedOrderData);
             } else {
                 window.location.href = '/pedidos.html';
             }
         }
 
        async function loadOrderSummary() {
             const summaryContainer = document.getElementById('payment-order-summary');
             if (!summaryContainer || !orderData) return;
 
            try {
                const breakdown = await computeFinancialBreakdown(orderData);
                const {
                    items,
                    subtotal,
                    subtotalAfterPromotions,
                    promotionDiscount,
                    promotionsLines,
                    deliveryFee,
                    taxes,
                    rewardDiscount,
                    loyaltyDiscount,
                    totalBeforeRewards,
                    total
                } = breakdown;

                Object.assign(orderData, {
                    subtotal,
                    subtotalAfterPromotions,
                    promotionDiscount,
                    promotionsApplied: promotionsLines,
                    deliveryFee,
                    taxes,
                    rewardDiscount,
                    loyaltyDiscount,
                    totalBeforeRewards,
                    total
                });

                const promotionsHTML = renderPromotionsBreakdown({ promotionsApplied: promotionsLines, promotionDiscount }, promotionDiscount);
                const rewardsLoyaltyHTML = renderRewardsLoyaltyBreakdown({ rewardDiscount, loyaltyDiscount }, rewardDiscount, loyaltyDiscount);

                summaryContainer.innerHTML = '';

                items.forEach(item => {
                    const itemRow = document.createElement('div');
                    itemRow.className = 'flex justify-between';
                    itemRow.innerHTML = `
                        <span class="text-gray-600">${item.name} x${item.quantity}</span>
                        <span>₡${(item.price * item.quantity).toLocaleString()}</span>
                    `;
                    summaryContainer.appendChild(itemRow);
                });

                const separator1 = document.createElement('hr');
                separator1.className = 'my-3';
                summaryContainer.appendChild(separator1);

                const subtotalRow = document.createElement('div');
                subtotalRow.className = 'flex justify-between';
                subtotalRow.innerHTML = `
                    <span class="text-gray-600">Subtotal</span>
                    <span>₡${subtotal.toLocaleString()}</span>
                `;
                summaryContainer.appendChild(subtotalRow);

                if (promotionsHTML) {
                    summaryContainer.insertAdjacentHTML('beforeend', promotionsHTML);
                }

                const deliveryRow = document.createElement('div');
                deliveryRow.className = 'flex justify-between';
                deliveryRow.innerHTML = `
                    <span class="text-gray-600">Costo de entrega</span>
                    <span>₡${deliveryFee.toLocaleString()}</span>
                `;
                summaryContainer.appendChild(deliveryRow);

                const taxRow = document.createElement('div');
                taxRow.className = 'flex justify-between';
                taxRow.innerHTML = `
                    <span class="text-gray-600">Impuestos</span>
                    <span>₡${Math.round(taxes).toLocaleString()}</span>
                `;
                summaryContainer.appendChild(taxRow);

                if (rewardsLoyaltyHTML) {
                    summaryContainer.insertAdjacentHTML('beforeend', rewardsLoyaltyHTML);
                }

                const separator2 = document.createElement('hr');
                separator2.className = 'my-3';
                summaryContainer.appendChild(separator2);

                const totalRow = document.createElement('div');
                totalRow.className = 'flex justify-between font-semibold text-lg';
                totalRow.innerHTML = `
                    <span>Total</span>
                    <span>₡${Math.round(total).toLocaleString()}</span>
                `;
                summaryContainer.appendChild(totalRow);
            } catch (error) {
                console.error('Error al calcular el resumen del pedido:', error);
                renderFallbackSummary(summaryContainer, orderData);
            }
        }
 
         function normalizePromotion(promo = {}) {
            const porcentaje = Number(
                promo?.porcentaje_descuento ??
                promo?.valor_descuento ??
                promo?.porcentaje ??
                promo?.valor ??
                0
            );

            let productos = [];
            if (Array.isArray(promo?.productos)) {
                productos = promo.productos
                    .map((producto) => Number(producto?.id_producto ?? producto?.id ?? producto))
                    .filter((id) => !Number.isNaN(id));
            }

            return {
                id: Number(promo?.id_promocion ?? promo?.id ?? 0),
                nombre: promo?.nombre_promocion ?? promo?.nombre ?? 'Promoción',
                descripcion: promo?.descripcion ?? '',
                alcance: promo?.alcance === 'producto' ? 'producto' : 'general',
                porcentaje: porcentaje > 0 ? porcentaje : 0,
                productos
            };
        }

        async function loadActivePromotions() {
            if (promotionsLoaded) {
                return activePromotions;
            }

            if (promotionsLoadingPromise) {
                return promotionsLoadingPromise;
            }

            promotionsLoadingPromise = (async () => {
                try {
                    const response = await fetch('/api/promociones/public/activas');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    const promociones = data?.data?.promociones || data?.promociones || [];
                    activePromotions = Array.isArray(promociones)
                        ? promociones.map(normalizePromotion).filter(promo => promo.porcentaje > 0)
                        : [];
                } catch (error) {
                    console.error('Error al cargar promociones activas:', error);
                    activePromotions = [];
                } finally {
                    promotionsLoaded = true;
                    promotionsLoadingPromise = null;
                }

                return activePromotions;
            })();

            return promotionsLoadingPromise;
        }

        function calculatePromotionsDiscount(subtotal, cartItems, promotions) {
            if (!Array.isArray(cartItems) || cartItems.length === 0 || !Array.isArray(promotions) || promotions.length === 0) {
                return { discount: 0, breakdown: [] };
            }

            const subtotalByProduct = new Map();

            cartItems.forEach((item) => {
                if (!item) return;
                const quantity = Number(item.quantity);
                const price = Number(item.price);
                if (Number.isNaN(quantity) || Number.isNaN(price) || quantity <= 0 || price < 0) {
                    return;
                }

                const lineSubtotal = price * quantity;
                const productId = Number(item.id);

                if (!Number.isNaN(productId)) {
                    subtotalByProduct.set(productId, (subtotalByProduct.get(productId) || 0) + lineSubtotal);
                }
            });

            let totalDiscount = 0;
            const breakdown = [];

            promotions.forEach((promo) => {
                if (!promo || promo.porcentaje <= 0) {
                    return;
                }

                const porcentaje = promo.porcentaje / 100;
                let applicableSubtotal = 0;

                if (promo.alcance === 'producto') {
                    if (!Array.isArray(promo.productos) || promo.productos.length === 0) {
                        return;
                    }

                    promo.productos.forEach((productId) => {
                        const subtotalProducto = subtotalByProduct.get(Number(productId));
                        if (subtotalProducto) {
                            applicableSubtotal += subtotalProducto;
                        }
                    });
                } else {
                    applicableSubtotal = subtotal;
                }

                if (applicableSubtotal <= 0) {
                    return;
                }

                const discountAmount = applicableSubtotal * porcentaje;

                if (discountAmount <= 0) {
                    return;
                }

                totalDiscount += discountAmount;
                breakdown.push({
                    label: promo.nombre,
                    amount: discountAmount,
                    alcance: promo.alcance
                });
            });

            if (totalDiscount > subtotal) {
                totalDiscount = subtotal;
            }

            return {
                discount: totalDiscount,
                breakdown
            };
        }

        async function computeFinancialBreakdown(order) {
             const items = Array.isArray(order.items) ? order.items : [];
             const subtotalFallback = items.reduce((sum, item) => {
                 const price = Number(item.price) || 0;
                 const quantity = Number(item.quantity) || 0;
                 return sum + price * quantity;
             }, 0);
 
            const subtotalRaw = Number(order.subtotal);
            const subtotal = Number.isFinite(subtotalRaw) && subtotalRaw > 0 ? subtotalRaw : subtotalFallback;

            const storedPromotionDiscount = Number(order.promotionDiscount);
            let promotionDiscount = Number.isFinite(storedPromotionDiscount) && storedPromotionDiscount > 0
                ? storedPromotionDiscount
                : 0;

            let promotionsApplied = Array.isArray(order.promotionsApplied)
                ? order.promotionsApplied.map(promo => ({
                    label: promo.label || promo.nombre || 'Descuento',
                    amount: Number(promo.amount) || Number(promo.valor) || 0,
                    alcance: promo.alcance || 'general'
                })).filter(promo => promo.amount > 0)
                : [];

            const hasStoredPromotions = promotionsApplied.length > 0;
            if (hasStoredPromotions && promotionDiscount <= 0) {
                promotionDiscount = promotionsApplied.reduce((sum, promo) => sum + (promo.amount || 0), 0);
            }

            let subtotalAfterPromotions = Number(order.subtotalAfterPromotions);
            if (!Number.isFinite(subtotalAfterPromotions) || subtotalAfterPromotions <= 0) {
                subtotalAfterPromotions = Math.max(0, subtotal - promotionDiscount);
            }

            if (!hasStoredPromotions && promotionDiscount <= 0) {
                const promotions = await loadActivePromotions();
                const { discount, breakdown } = calculatePromotionsDiscount(subtotal, items, promotions);
                promotionDiscount = discount;
                promotionsApplied = breakdown;
                subtotalAfterPromotions = Math.max(0, subtotal - promotionDiscount);
            }

            let deliveryFee = Number(order.deliveryFee);
            if (!Number.isFinite(deliveryFee)) {
                const deliveryFeeFromDelivery = Number(order.delivery?.fee);
                deliveryFee = Number.isFinite(deliveryFeeFromDelivery) ? deliveryFeeFromDelivery : deliveryFee >= 0 ? deliveryFee : 1500;
            }
            if (!Number.isFinite(deliveryFee) || deliveryFee < 0) {
                deliveryFee = 1500;
            }

            const computedTaxes = subtotalAfterPromotions * TAX_RATE;
            let taxes = Number(order.taxes);
            if (!Number.isFinite(taxes) || taxes < 0) {
                taxes = computedTaxes;
            }
            if (Math.abs(taxes - computedTaxes) > 0.5) {
                taxes = computedTaxes;
            }

            const rewardDiscountRaw = Number(order.rewardDiscount);
            const rewardDiscount = Number.isFinite(rewardDiscountRaw) && rewardDiscountRaw > 0
                ? rewardDiscountRaw
                : Number(order.rewardCanje?.valor_canje) || 0;

            const loyaltyDiscountRaw = Number(order.loyaltyDiscount);
            const loyaltyDiscount = Number.isFinite(loyaltyDiscountRaw) && loyaltyDiscountRaw > 0
                ? loyaltyDiscountRaw
                : 0;

            const totalBeforeRewards = subtotalAfterPromotions + deliveryFee + taxes;
            const computedTotal = Math.max(0, totalBeforeRewards - rewardDiscount - loyaltyDiscount);
            let total = Number(order.total);
            if (!Number.isFinite(total) || Math.abs(total - computedTotal) > 0.5) {
                total = computedTotal;
            }
 
            return {
                items,
                subtotal,
                subtotalAfterPromotions,
                promotionDiscount,
                promotionsLines: promotionsApplied,
                deliveryFee,
                taxes,
                rewardDiscount,
                loyaltyDiscount,
                totalBeforeRewards,
                total
            };
        }

        //Selecciona el método de pago
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            document.querySelectorAll('.payment-radio').forEach(el => {
                el.classList.remove('bg-orange-500', 'border-orange-500');
                el.classList.add('border-gray-300');
            });
 
            const sinpeDetails = document.getElementById('sinpe-details');
            if (sinpeDetails) {
                sinpeDetails.classList.add('hidden');
            }
 
            const selectedElement = document.querySelector(`[data-method="${method}"]`).closest('.payment-method');
            selectedElement.classList.add('selected');
            
            const radio = selectedElement.querySelector('.payment-radio');
            radio.classList.remove('border-gray-300');
            radio.classList.add('bg-orange-500', 'border-orange-500');
 
            if (method === 'sinpe' && sinpeDetails) {
                sinpeDetails.classList.remove('hidden');
            }
        }

        //Valida el formulario de pago
        function validatePaymentForm() {
             if (!selectedPaymentMethod) {
                 alert('Por favor selecciona un método de pago.');
                 return false;
             }
 
            if (selectedPaymentMethod === 'sinpe') {
                const sinpeReference = document.getElementById('sinpeReference').value.trim();
                if (!sinpeReference) {
                    alert('Por favor ingresa el número de comprobante del SINPE.');
                    return false;
                }
            }
 
             return true;
         }

        //Procesa el pago
        async function processPayment() {
            if (!validatePaymentForm()) {
                return;
            }

            const button = document.querySelector('button[onclick="processPayment()"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
            button.disabled = true;

            try {
                const paymentData = {
                    method: selectedPaymentMethod,
                    timestamp: new Date().toISOString()
                };

                if (selectedPaymentMethod === 'sinpe') {
                    paymentData.sinpeReference = document.getElementById('sinpeReference').value.trim();
                }

                let breakdown;
                try {
                    breakdown = await computeFinancialBreakdown(orderData);
                } catch (calcError) {
                    console.error('No se pudo recalcular totales antes de enviar el pedido:', calcError);
                }

                const effectiveTotals = breakdown ? {
                    subtotal: breakdown.subtotal,
                    subtotalAfterPromotions: breakdown.subtotalAfterPromotions,
                    promotionDiscount: breakdown.promotionDiscount,
                    promotionsApplied: breakdown.promotionsLines,
                    deliveryFee: breakdown.deliveryFee,
                    taxes: breakdown.taxes,
                    rewardDiscount: breakdown.rewardDiscount,
                    loyaltyDiscount: breakdown.loyaltyDiscount,
                    totalBeforeRewards: breakdown.totalBeforeRewards,
                    total: breakdown.total
                } : {
                    subtotal: orderData.subtotal || 0,
                    subtotalAfterPromotions: orderData.subtotalAfterPromotions || orderData.subtotal || 0,
                    promotionDiscount: orderData.promotionDiscount || 0,
                    promotionsApplied: orderData.promotionsApplied || [],
                    deliveryFee: orderData.deliveryFee || 1500,
                    taxes: orderData.taxes || ((orderData.subtotalAfterPromotions || orderData.subtotal || 0) * TAX_RATE),
                    rewardDiscount: orderData.rewardDiscount || 0,
                    loyaltyDiscount: orderData.loyaltyDiscount || 0,
                    totalBeforeRewards: orderData.totalBeforeRewards || ((orderData.subtotalAfterPromotions || orderData.subtotal || 0) + (orderData.deliveryFee || 1500) + (orderData.taxes || ((orderData.subtotalAfterPromotions || orderData.subtotal || 0) * TAX_RATE))),
                    total: orderData.total || 0
                };

                //Prepara los datos del pedido para enviar al backend
                const orderPayload = {
                    items: orderData.items,
                    customer: orderData.customer,
                    delivery: orderData.delivery,
                    payment: paymentData,
                    subtotal: effectiveTotals.subtotal,
                    subtotalAfterPromotions: effectiveTotals.subtotalAfterPromotions,
                    deliveryFee: effectiveTotals.deliveryFee,
                    taxes: effectiveTotals.taxes,
                    promotionDiscount: effectiveTotals.promotionDiscount,
                    promotionsApplied: effectiveTotals.promotionsApplied,
                    total: effectiveTotals.total,
                    loyaltyDiscount: effectiveTotals.loyaltyDiscount,
                    totalBeforeRewards: effectiveTotals.totalBeforeRewards,
                    totalBeforeLoyalty: orderData.totalBeforeLoyalty,
                    loyaltyPointsUsed: 0
                };

                if (orderData.rewardCanje && orderData.rewardCanje.id_canje) {
                    orderPayload.rewardCanjeId = orderData.rewardCanje.id_canje;
                    orderPayload.rewardDiscount = effectiveTotals.rewardDiscount || orderData.rewardCanje.valor_canje || 0;
                }

                //Envía el pedido al backend
                const authToken = localStorage.getItem('authToken');
                const isAuthenticated = authToken && authToken !== 'null' && authToken !== '';
                
                //Usar endpoint diferente según si el usuario está autenticado o es invitado
                const endpoint = isAuthenticated ? '/api/pedidos' : '/api/pedidos/guest';
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                //Solo agregar Authorization header si el usuario está autenticado
                if (isAuthenticated) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(orderPayload)
                });

                const result = await response.json();

                if (result.success) {
                    const completeOrder = {
                        ...orderData,
                        payment: paymentData,
                        id: result.data.pedidoId,
                        numeroPedido: result.data.numeroPedido,
                        status: 'confirmed',
                        timestamp: new Date().toISOString()
                    };

                    localStorage.setItem('sunsets-complete-order', JSON.stringify(completeOrder));
                    localStorage.removeItem('sunsets-order-data');
                    localStorage.removeItem('pendingOrder');
                    localStorage.removeItem('sunsets-cart');
                    localStorage.removeItem('sunsets-active-reward');

                    window.location.href = '/confirmacion.html';
                } else {
                    throw new Error(result.message || 'Error al procesar el pedido');
                }

            } catch (error) {
                console.error('Error al procesar pago:', error);
                alert('Error al procesar el pedido: ' + error.message);
                
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        //Genera un ID aleatorio para el pedido
        function generateOrderId() {
            return Math.floor(10000 + Math.random() * 90000);
        }

        function getPaymentMethodName(method) {
             const methods = {
                 'efectivo': 'Pago en Efectivo',
                 'sinpe': 'SINPE Móvil'
             };
             return methods[method] || method;
         }

        function renderPromotionsBreakdown(order, promotionDiscountOverride) {
            const promotions = Array.isArray(order.promotionsApplied) ? order.promotionsApplied : (order.promotionsApplied || []);
            const promotionDiscount = Number(promotionDiscountOverride ?? order.promotionDiscount) || 0;

            if ((!Array.isArray(promotions) || promotions.length === 0) && promotionDiscount <= 0) {
                return '';
            }

            const lines = [];

            if (Array.isArray(promotions) && promotions.length > 0) {
                promotions.forEach((promo) => {
                    if (!promo) return;
                    const label = promo.label || 'Descuento';
                    const amount = Number(promo.amount) || 0;
                    if (amount <= 0) return;
                    lines.push(`
                        <div class="flex justify-between text-green-600 font-semibold">
                            <span>${label}</span>
                            <span>-₡${Math.round(amount).toLocaleString()}</span>
                        </div>
                    `);
                });
            } else if (promotionDiscount > 0) {
                lines.push(`
                    <div class="flex justify-between text-green-600 font-semibold">
                        <span>Descuento promocional</span>
                        <span>-₡${Math.round(promotionDiscount).toLocaleString()}</span>
                    </div>
                `);
            }

            return lines.join('');
        }

        function renderRewardsLoyaltyBreakdown(order, rewardDiscountOverride, loyaltyDiscountOverride) {
            const lines = [];
            const rewardDiscount = Number(rewardDiscountOverride ?? order.rewardDiscount) || 0;
            const loyaltyDiscount = Number(loyaltyDiscountOverride ?? order.loyaltyDiscount) || 0;

            if (rewardDiscount > 0) {
                lines.push(`
                    <div class="flex justify-between text-green-600 font-semibold">
                        <span>Descuento por recompensa</span>
                        <span>-₡${Math.round(rewardDiscount).toLocaleString()}</span>
                    </div>
                `);
            }

            if (loyaltyDiscount > 0) {
                lines.push(`
                    <div class="flex justify-between text-green-600 font-semibold">
                        <span>Descuento por puntos de lealtad</span>
                        <span>-₡${Math.round(loyaltyDiscount).toLocaleString()}</span>
                    </div>
                `);
            }

            return lines.join('');
        }

        function renderFallbackSummary(container, order) {
            const items = Array.isArray(order.items) ? order.items : [];
            const subtotal = items.reduce((sum, item) => sum + ((Number(item.price) || 0) * (Number(item.quantity) || 0)), 0);
            const promotionDiscount = Math.max(0, Number(order.promotionDiscount) || 0);
            const subtotalAfterPromotions = Math.max(0, subtotal - promotionDiscount);
            const deliveryFee = Number(order.deliveryFee) || 1500;
            const taxes = subtotalAfterPromotions * TAX_RATE;
            const rewardDiscount = Number(order.rewardDiscount) || 0;
            const loyaltyDiscount = Number(order.loyaltyDiscount) || 0;
            const total = Math.max(0, subtotalAfterPromotions + deliveryFee + taxes - rewardDiscount - loyaltyDiscount);

            container.innerHTML = '';

            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'flex justify-between';
                row.innerHTML = `
                    <span class="text-gray-600">${item.name} x${item.quantity}</span>
                    <span>₡${(item.price * item.quantity).toLocaleString()}</span>
                `;
                container.appendChild(row);
            });

            const separator1 = document.createElement('hr');
            separator1.className = 'my-3';
            container.appendChild(separator1);

            container.insertAdjacentHTML('beforeend', `
                <div class="flex justify-between">
                    <span class="text-gray-600">Subtotal</span>
                    <span>₡${subtotal.toLocaleString()}</span>
                </div>
            `);

            container.insertAdjacentHTML('beforeend', `
                <div class="flex justify-between">
                    <span class="text-gray-600">Costo de entrega</span>
                    <span>₡${deliveryFee.toLocaleString()}</span>
                </div>
            `);

            container.insertAdjacentHTML('beforeend', `
                <div class="flex justify-between">
                    <span class="text-gray-600">Impuestos</span>
                    <span>₡${Math.round(taxes).toLocaleString()}</span>
                </div>
            `);

            if (rewardDiscount > 0) {
                container.insertAdjacentHTML('beforeend', `
                    <div class="flex justify-between text-green-600 font-semibold">
                        <span>Descuento por recompensa</span>
                        <span>-₡${Math.round(rewardDiscount).toLocaleString()}</span>
                    </div>
                `);
            }

            if (loyaltyDiscount > 0) {
                container.insertAdjacentHTML('beforeend', `
                    <div class="flex justify-between text-green-600 font-semibold">
                        <span>Descuento por puntos de lealtad</span>
                        <span>-₡${Math.round(loyaltyDiscount).toLocaleString()}</span>
                    </div>
                `);
            }

            const separator2 = document.createElement('hr');
            separator2.className = 'my-3';
            container.appendChild(separator2);

            container.insertAdjacentHTML('beforeend', `
                <div class="flex justify-between font-semibold text-lg">
                    <span>Total</span>
                    <span>₡${Math.round(total).toLocaleString()}</span>
                </div>
            `);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const sinpeReferenceInput = document.getElementById('sinpeReference');
            if (sinpeReferenceInput) {
                sinpeReferenceInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
            }
        });

    </script>
</body>
</html>
