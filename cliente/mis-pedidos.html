<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Pedidos - Sunset's Tarbaca</title>
    <link rel="icon" type="image/png" href="/sunsets_logo_b.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/navbar.js"></script>
    <script src="/js/footer.js"></script>
    <script src="/js/routeProtection.js"></script>
    <script src="/js/orders.js"></script>
    <style>
        .order-card {
            transition: all 0.3s ease;
        }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
        }
        .status-pendiente { background-color: #fef3c7; color: #92400e; }
        .status-confirmado { background-color: #dbeafe; color: #1e40af; }
        .status-preparando { background-color: #fed7aa; color: #ea580c; }
        .status-listo { background-color: #bbf7d0; color: #166534; }
        .status-en_camino { background-color: #c7d2fe; color: #3730a3; }
        .status-entregado { background-color: #dcfce7; color: #166534; }
        .status-cancelado { background-color: #fecaca; color: #dc2626; }
        
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 2rem 2rem 1rem 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background-color: #f3f4f6;
            color: #374151;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Navbar Container -->
    <div id="navbar-container"></div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8 flex-grow">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Mis Pedidos</h1>
                    <p class="text-gray-600">Gestiona y revisa el historial de tus pedidos</p>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">Filtrar por estado:</label>
                    <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="">Todos los estados</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="confirmado">Confirmado</option>
                        <option value="preparando">Preparando</option>
                        <option value="listo">Listo</option>
                        <option value="en_camino">En Camino</option>
                        <option value="entregado">Entregado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">Ordenar por:</label>
                    <select id="sortFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <option value="fecha_desc">Más recientes</option>
                        <option value="fecha_asc">Más antiguos</option>
                        <option value="total_desc">Mayor monto</option>
                        <option value="total_asc">Menor monto</option>
                    </select>
                </div>
                
                <button onclick="clearFilters()" class="text-sm text-gray-600 hover:text-gray-800 underline">
                    Limpiar filtros
                </button>
            </div>
        </div>

        <!-- Orders Container -->
        <div id="orders-container">
            <!-- Loading State -->
            <div id="loading-state" class="space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="loading-skeleton h-6 w-1/3 rounded mb-4"></div>
                    <div class="loading-skeleton h-4 w-1/2 rounded mb-2"></div>
                    <div class="loading-skeleton h-4 w-1/4 rounded"></div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="loading-skeleton h-6 w-1/3 rounded mb-4"></div>
                    <div class="loading-skeleton h-4 w-1/2 rounded mb-2"></div>
                    <div class="loading-skeleton h-4 w-1/4 rounded"></div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="text-center py-16 hidden">
                <div class="bg-white rounded-lg shadow-md p-12">
                    <i class="fas fa-shopping-bag text-6xl text-gray-300 mb-6"></i>
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">No tienes pedidos aún</h2>
                    <p class="text-gray-600 mb-8">¡Haz tu primer pedido y descubre nuestros deliciosos platos!</p>
                    <a href="/menu.html" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-3 rounded-lg hover:from-orange-600 hover:to-red-600 transition font-semibold inline-flex items-center justify-center gap-2">
                        <i class="fas fa-plus"></i>
                        Hacer Pedido
                    </a>
                </div>
            </div>

            <!-- Orders List -->
            <div id="orders-list" class="space-y-6 hidden">
                <!-- Los pedidos se cargarán dinámicamente aquí -->
            </div>

            <div id="paginationControls" class="hidden mt-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div id="paginationSummary" class="text-sm text-gray-600">
                    Mostrando 0 - 0 de 0 pedidos
                </div>
                <div class="flex items-center gap-2">
                    <button id="prevPageBtn" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-left mr-1"></i> Anterior
                    </button>
                    <div id="paginationInfo" class="text-sm font-semibold text-gray-700">
                        Página 1 de 1
                    </div>
                    <button id="nextPageBtn" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        Siguiente <i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Container -->
    <div id="footer-container" class="mt-auto"></div>

        <!-- Order Details Modal -->
        <div id="orderDetailsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="text-xl font-semibold text-gray-800" id="modalOrderNumber">#000000</h3>
                    <button type="button" class="modal-close" onclick="closeOrderDetailsModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Loading State -->
                <div id="modalLoadingState" class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500"></div>
                    <p class="mt-2 text-gray-600">Cargando detalles del pedido...</p>
                </div>

                <!-- Order Content -->
                <div id="modalOrderContent" class="hidden">
                    <!-- Order Info -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm text-gray-500" id="modalOrderDate">Fecha del pedido</span>
                            <div id="modalOrderStatus" class="status-badge">Pendiente</div>
                        </div>
                    </div>

                    <!-- Order Items -->
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Items del Pedido</h4>
                        <div id="modalOrderItems" class="space-y-3">
                            <!-- Items will be loaded here -->
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Resumen del Pedido</h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="space-y-2" id="modalOrderSummary">
                                <!-- El resumen se calculará dinámicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Payment Information -->
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Información de Pago</h4>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-credit-card text-blue-600"></i>
                                <div>
                                    <div class="font-semibold text-blue-800">Método de Pago</div>
                                    <div class="text-blue-700" id="modalPaymentMethod">Efectivo</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loyalty Points -->
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Puntos de Lealtad</h4>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-star text-green-600"></i>
                                <div>
                                    <div class="font-semibold text-green-800">Puntos Ganados</div>
                                    <div class="text-green-700" id="modalLoyaltyPoints">0 puntos</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Special Notes -->
                    <div id="modalSpecialNotes" class="mb-6 hidden">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Notas Especiales</h4>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-sticky-note text-yellow-600 mt-1"></i>
                                <div>
                                    <div class="font-semibold text-yellow-800">Instrucciones</div>
                                    <div class="text-yellow-700" id="modalNotesText">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="flex justify-end pt-4">
                        <button id="modalReorderBtn" onclick="reorderFromModal()" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-6 py-2 rounded-lg hover:from-orange-600 hover:to-red-600 transition font-semibold hidden">
                            <i class="fas fa-redo mr-2"></i>
                            Pedir de Nuevo
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Calificación de Productos -->
        <div id="calificarModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="text-xl font-semibold text-gray-800">Calificar Productos del Pedido</h3>
                    <button type="button" class="modal-close" onclick="cerrarModalCalificar()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="calificarModalContent" class="space-y-4">
                    <!-- Los productos se cargarán dinámicamente aquí -->
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 mt-4">
                    <button onclick="cerrarModalCalificar()" 
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">
                        Cancelar
                    </button>
                    <button onclick="enviarCalificaciones()" 
                            class="px-4 py-2 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-md hover:from-orange-600 hover:to-red-600 transition">
                        Enviar Calificaciones
                    </button>
                </div>
            </div>
        </div>

    <script>
        // Hacer las funciones globales para que estén disponibles desde onclick
        window.calificarPedido = null;
        window.seleccionarEstrellaCalificar = null;
        window.pintarEstrellasCalificar = null;
        window.cerrarModalCalificar = null;
        window.enviarCalificaciones = null;
        
        let allOrders = [];
        let filteredOrders = [];
        let currentPage = 1;
        const ITEMS_PER_PAGE = 5;

        let paginationControls;
        let paginationSummary;
        let paginationInfo;
        let prevPageBtn;
        let nextPageBtn;
 
        document.addEventListener('DOMContentLoaded', function() {
            setupPaginationControls();
            loadOrders();
            setupFilters();
            setupModalEventListeners();
            setupCalificarModalEventListeners();
        });

        function setupPaginationControls() {
            paginationControls = document.getElementById('paginationControls');
            paginationSummary = document.getElementById('paginationSummary');
            paginationInfo = document.getElementById('paginationInfo');
            prevPageBtn = document.getElementById('prevPageBtn');
            nextPageBtn = document.getElementById('nextPageBtn');

            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', () => changePage(-1));
            }

            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', () => changePage(1));
            }
        }

        //Configura los event listeners del modal de detalles del pedido
        function setupModalEventListeners() {
            document.getElementById('orderDetailsModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeOrderDetailsModal();
                }
            });

            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const modal = document.getElementById('orderDetailsModal');
                    if (modal.classList.contains('show')) {
                        closeOrderDetailsModal();
                    }
                }
            });
        }

        //Carga los pedidos del cliente autenticado
        async function loadOrders() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    console.error('No hay token de autenticación');
                    return;
                }

                const response = await fetch('/api/pedidos', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    allOrders = result.pedidos || [];
                    // Verificar y generar facturas para pedidos confirmados/entregados sin factura
                    for (const order of allOrders) {
                        if ((order.estado_pedido === 'confirmado' || order.estado_pedido === 'entregado') && !order.factura_id) {
                            // Intentar generar factura en segundo plano
                            generarFacturaSiNoExiste(order.id_pedido);
                        }
                    }
                    filteredOrders = [...allOrders];
                    currentPage = 1;
                    displayOrders();
                } else {
                    console.error('Error al cargar pedidos:', result.message);
                    showEmptyState();
                }
            } catch (error) {
                console.error('Error al cargar pedidos:', error);
                showEmptyState();
            }
        }

        // Función para generar factura si no existe
        async function generarFacturaSiNoExiste(pedidoId) {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) return;

                const response = await fetch(`/api/facturas/pedido/${pedidoId}/generar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                if (result.success) {
                    console.log(`Factura generada para pedido ${pedidoId}`);
                    // Recargar pedidos después de un breve delay
                    setTimeout(() => {
                        loadOrders();
                    }, 2000);
                }
            } catch (error) {
                console.error(`Error al generar factura para pedido ${pedidoId}:`, error);
            }
        }

        //Muestra los pedidos en la lista
        function displayOrders() {
            const loadingState = document.getElementById('loading-state');
            const emptyState = document.getElementById('empty-state');
            const ordersList = document.getElementById('orders-list');

            loadingState.classList.add('hidden');

            if (filteredOrders.length === 0) {
                showEmptyState();
                return;
            }

            ordersList.classList.remove('hidden');
            emptyState.classList.add('hidden');

            const totalPages = Math.ceil(filteredOrders.length / ITEMS_PER_PAGE) || 1;
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            if (currentPage < 1) {
                currentPage = 1;
            }

            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, filteredOrders.length);
            const paginatedOrders = filteredOrders.slice(startIndex, endIndex);

            ordersList.innerHTML = paginatedOrders.map(order => createOrderCard(order)).join('');
            renderPagination(totalPages, startIndex, endIndex);
        }

        function renderPagination(totalPages, startIndex, endIndex) {
            if (!paginationControls || !paginationSummary || !paginationInfo || !prevPageBtn || !nextPageBtn) {
                return;
            }

            if (filteredOrders.length === 0) {
                paginationControls.classList.add('hidden');
                return;
            }

            paginationControls.classList.remove('hidden');

            const total = filteredOrders.length;
            const start = startIndex + 1;
            const end = endIndex;

            paginationSummary.textContent = `Mostrando ${start} - ${end} de ${total} pedidos`;
            paginationInfo.textContent = `Página ${currentPage} de ${totalPages}`;

            const isFirstPage = currentPage <= 1;
            const isLastPage = currentPage >= totalPages;

            prevPageBtn.disabled = isFirstPage;
            nextPageBtn.disabled = isLastPage;
        }

        function changePage(offset) {
            goToPage(currentPage + offset);
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredOrders.length / ITEMS_PER_PAGE) || 1;
            if (page < 1 || page > totalPages) {
                return;
            }
            currentPage = page;
            displayOrders();
        }

        //Crea el card del pedido
        function createOrderCard(order) {
            const statusInfo = getStatusInfo(order.estado_pedido);
            const formattedDate = formatDate(order.fecha_pedido);
            const orderNumber = `#${order.id_pedido.toString().padStart(6, '0')}`;

            return `
                <div class="order-card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-receipt text-white text-lg"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">${orderNumber}</h3>
                                <p class="text-sm text-gray-600">${formattedDate}</p>
                            </div>
                        </div>
                        <div class="text-right flex flex-col items-end">
                            <div class="status-badge ${statusInfo.class}">${statusInfo.text}</div>
                            <p class="text-lg font-bold text-gray-800 mt-2">₡${order.total.toLocaleString()}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <div class="text-sm text-gray-600">Items</div>
                            <div class="font-semibold">${order.total_items || 0}</div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <div class="text-sm text-gray-600">Método de Pago</div>
                            <div class="font-semibold">${getPaymentMethodText(order.metodo_pago)}</div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <div class="text-sm text-gray-600">Puntos Ganados</div>
                            <div class="font-semibold">${order.puntos_otorgados || 0}</div>
                        </div>
                    </div>

                    ${order.notas_especiales ? `
                        <div class="inline-block bg-yellow-50 border border-yellow-200 rounded-lg p-2 mb-3 max-w-full">
                            <p class="text-sm text-yellow-800 whitespace-normal">
                                <i class="fas fa-sticky-note mr-1"></i>
                                <strong>Notas especiales:</strong> ${order.notas_especiales}
                            </p>
                        </div>
                    ` : ''}

                    <div class="flex items-center justify-between flex-wrap gap-2">
                        <button onclick="viewOrderDetails(${order.id_pedido})" class="text-orange-600 hover:text-orange-700 font-semibold flex items-center gap-2">
                            <i class="fas fa-eye"></i>
                            Ver Detalles
                        </button>
                        
                        <div class="flex items-center gap-2">
                            ${order.factura_id ? `
                                <button onclick="viewInvoice(${order.factura_id})" class="bg-blue-100 text-blue-700 hover:bg-blue-200 px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2">
                                    <i class="fas fa-file-invoice"></i>
                                    Ver Factura
                                </button>
                                <button onclick="downloadInvoice(${order.factura_id})" class="bg-green-100 text-green-700 hover:bg-green-200 px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2">
                                    <i class="fas fa-download"></i>
                                    Descargar PDF
                                </button>
                            ` : (order.estado_pedido === 'confirmado' || order.estado_pedido === 'entregado' ? `
                                <span class="text-sm text-gray-500 italic">Factura en proceso...</span>
                            ` : '')}
                            
                            ${order.estado_pedido === 'entregado' ? `
                                <button onclick="calificarPedido(${order.id_pedido})" class="bg-yellow-100 text-yellow-700 hover:bg-yellow-200 px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2">
                                    <i class="fas fa-star"></i>
                                    Calificar
                                </button>
                                <button onclick="reorderItems(${order.id_pedido})" class="bg-orange-100 text-orange-700 hover:bg-orange-200 px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2">
                                    <i class="fas fa-redo"></i>
                                    Pedir de Nuevo
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        //Obtiene la información del estado del pedido
        function getStatusInfo(status) {
            const statusMap = {
                'pendiente': { text: 'Pendiente', class: 'status-pendiente' },
                'confirmado': { text: 'Confirmado', class: 'status-confirmado' },
                'preparando': { text: 'Preparando', class: 'status-preparando' },
                'listo': { text: 'Listo', class: 'status-listo' },
                'en_camino': { text: 'En Camino', class: 'status-en_camino' },
                'entregado': { text: 'Entregado', class: 'status-entregado' },
                'cancelado': { text: 'Cancelado', class: 'status-cancelado' }
            };
            return statusMap[status] || { text: status, class: 'status-pendiente' };
        }

        //Obtiene el texto del método de pago
        function getPaymentMethodText(method) {
            const methodMap = {
                'efectivo': 'Efectivo',
                'tarjeta': 'Tarjeta',
                'transferencia': 'Transferencia',
                'sinpe': 'SINPE Móvil'
            };
            return methodMap[method] || method;
        }

        //Formatea la fecha del pedido
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        //Muestra el estado vacío de la lista de pedidos
        function showEmptyState() {
            const loadingState = document.getElementById('loading-state');
            const emptyState = document.getElementById('empty-state');
            const ordersList = document.getElementById('orders-list');

            loadingState.classList.add('hidden');
            ordersList.classList.add('hidden');
            emptyState.classList.remove('hidden');

            if (paginationControls) {
                paginationControls.classList.add('hidden');
            }
        }

        //Configura los filtros de la lista de pedidos
        function setupFilters() {
            const statusFilter = document.getElementById('statusFilter');
            const sortFilter = document.getElementById('sortFilter');

            statusFilter.addEventListener('change', applyFilters);
            sortFilter.addEventListener('change', applyFilters);
        }

        //Aplica los filtros a la lista de pedidos
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;

            filteredOrders = allOrders.filter(order => {
                if (!statusFilter) return true;
                return order.estado_pedido === statusFilter;
            });

            currentPage = 1;

            filteredOrders.sort((a, b) => {
                switch (sortFilter) {
                    case 'fecha_desc':
                        return new Date(b.fecha_pedido) - new Date(a.fecha_pedido);
                    case 'fecha_asc':
                        return new Date(a.fecha_pedido) - new Date(b.fecha_pedido);
                    case 'total_desc':
                        return b.total - a.total;
                    case 'total_asc':
                        return a.total - b.total;
                    default:
                        return 0;
                }
            });

            displayOrders();
        }

        //Limpia los filtros de la lista de pedidos
        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('sortFilter').value = 'fecha_desc';
            filteredOrders = [...allOrders];
            currentPage = 1;
            displayOrders();
        }

        //Muestra los detalles del pedido en el modal
        async function viewOrderDetails(orderId) {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    console.error('No hay token de autenticación');
                    return;
                }

                const modal = document.getElementById('orderDetailsModal');
                modal.classList.add('show');
                document.getElementById('modalLoadingState').classList.remove('hidden');
                document.getElementById('modalOrderContent').classList.add('hidden');

                const response = await fetch(`/api/pedidos/${orderId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    const order = result.data.pedido;
                    populateOrderDetailsModal(order);
                    document.getElementById('modalLoadingState').classList.add('hidden');
                    document.getElementById('modalOrderContent').classList.remove('hidden');
                } else {
                    console.error('Error al cargar detalles del pedido:', result.message);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Error al cargar los detalles del pedido: ' + (result.message || 'Error desconocido')
                    });
                    closeOrderDetailsModal();
                }
            } catch (error) {
                console.error('Error al cargar detalles del pedido:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error de conexión al cargar los detalles del pedido'
                });
                closeOrderDetailsModal();
            }
        }

        //Llena el modal con los detalles del pedido
        function populateOrderDetailsModal(order) {
            document.getElementById('modalOrderNumber').textContent = `Pedido #${order.id_pedido.toString().padStart(6, '0')}`;
            document.getElementById('modalOrderDate').textContent = formatDate(order.fecha_pedido);

            const statusInfo = getStatusInfo(order.estado_pedido);
            const statusElement = document.getElementById('modalOrderStatus');
            statusElement.textContent = statusInfo.text;
            statusElement.className = `status-badge ${statusInfo.class}`;

            const itemsContainer = document.getElementById('modalOrderItems');
            if (order.productos && order.productos.length > 0) {
                itemsContainer.innerHTML = order.productos.map(item => {
                    let productName;
                    if (item.producto_nombre) {
                        productName = item.producto_nombre;
                    } else if (item.id_producto) {
                        productName = `Producto #${item.id_producto}`;
                    } else {
                        productName = `Producto (₡${item.precio_unitario.toLocaleString()})`;
                    }
                    
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-3 flex-1 min-w-0">
                                <div class="w-8 h-8 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-utensils text-white text-sm"></i>
                                </div>
                                <div class="flex-1 min-w-0 max-w-xs">
                                    <div class="font-semibold text-sm">${productName}</div>
                                    ${item.producto_descripcion ? `<div class="text-xs text-gray-600 truncate">${item.producto_descripcion}</div>` : ''}
                                    ${!item.producto_nombre && !item.id_producto ? `<div class="text-xs text-gray-500 italic">Pedido histórico</div>` : ''}
                                </div>
                            </div>
                            <div class="text-right flex-shrink-0 ml-4">
                                <div class="font-semibold text-sm">Cantidad: ${item.cantidad}</div>
                                <div class="text-xs text-gray-600">₡${item.precio_unitario.toLocaleString()} c/u</div>
                                <div class="font-semibold text-orange-600 text-sm">₡${item.subtotal_item.toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                itemsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No hay items disponibles</p>';
            }

            // Calcular y mostrar el resumen del pedido correctamente
            renderOrderSummary(order);

            document.getElementById('modalPaymentMethod').textContent = getPaymentMethodText(order.metodo_pago);

            const specialNotesDiv = document.getElementById('modalSpecialNotes');
            const notesText = document.getElementById('modalNotesText');
            if (order.notas_especiales && order.notas_especiales.trim()) {
                notesText.textContent = order.notas_especiales;
                specialNotesDiv.classList.remove('hidden');
            } else {
                specialNotesDiv.classList.add('hidden');
            }

            document.getElementById('modalLoyaltyPoints').textContent = `${order.puntos_otorgados || 0} puntos`;

            const reorderBtn = document.getElementById('modalReorderBtn');
            if (order.estado_pedido === 'entregado') {
                reorderBtn.classList.remove('hidden');
                reorderBtn.setAttribute('data-order-id', order.id_pedido);
            } else {
                reorderBtn.classList.add('hidden');
            }
        }

        //Cierra el modal de detalles del pedido
        function closeOrderDetailsModal() {
            const modal = document.getElementById('orderDetailsModal');
            modal.classList.remove('show');
            
            document.getElementById('modalLoadingState').classList.remove('hidden');
            document.getElementById('modalOrderContent').classList.add('hidden');
        }

        //Ver factura en nueva ventana
        async function viewInvoice(facturaId) {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Debes iniciar sesión para ver la factura'
                    });
                    return;
                }

                const response = await fetch(`/api/facturas/${facturaId}/pdf`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    window.open(url, '_blank');
                } else {
                    const result = await response.json();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message || 'No se pudo cargar la factura'
                    });
                }
            } catch (error) {
                console.error('Error al ver factura:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error de conexión al cargar la factura'
                });
            }
        }

        //Descargar factura PDF
        async function downloadInvoice(facturaId) {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Debes iniciar sesión para descargar la factura'
                    });
                    return;
                }

                const response = await fetch(`/api/facturas/${facturaId}/pdf`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `factura_${facturaId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Descarga exitosa',
                        text: 'La factura se ha descargado correctamente',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    const result = await response.json();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message || 'No se pudo descargar la factura'
                    });
                }
            } catch (error) {
                console.error('Error al descargar factura:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error de conexión al descargar la factura'
                });
            }
        }

        //Reordena los items del pedido desde el modal
        function reorderFromModal() {
            const orderId = document.getElementById('modalReorderBtn').getAttribute('data-order-id');
            if (orderId) {
                reorderItems(orderId);
                closeOrderDetailsModal();
            }
        }

        //Reordena los items del pedido
        function reorderItems(orderId) {
            alert(`Reordenar items del pedido #${orderId.toString().padStart(6, '0')}`);
        }

        //Calcula y renderiza el resumen del pedido correctamente usando la lógica unificada
        async function renderOrderSummary(order) {
            const summaryContainer = document.getElementById('modalOrderSummary');
            if (!summaryContainer) return;

            // Esperar a que orders.js esté cargado
            let retries = 0;
            while (typeof window.renderOrderSummaryHTML !== 'function' && retries < 10) {
                await new Promise(resolve => setTimeout(resolve, 100));
                retries++;
            }

            if (typeof window.renderOrderSummaryHTML !== 'function') {
                console.error('renderOrderSummaryHTML no está disponible');
                // Fallback básico
                renderOrderSummaryFallback(order, summaryContainer);
                return;
            }

            // Adaptar el objeto order de la API al formato esperado por renderOrderSummaryHTML
            const items = (order.productos || []).map(item => ({
                id: item.id_producto || null,
                name: item.producto_nombre || `Producto #${item.id_producto || 'N/A'}`,
                price: parseFloat(item.precio_unitario || 0),
                quantity: parseInt(item.cantidad || 0),
                originalPrice: parseFloat(item.precio_unitario || 0),
                finalPrice: parseFloat(item.precio_unitario || 0),
                hasDiscount: false
            }));

            // Obtener valores de la BD
            const subtotalBD = parseFloat(order.subtotal || 0);
            const deliveryFee = 1500; // Costo de entrega estándar
            const descuentosRecompensasBD = parseFloat(order.descuentos || 0);
            const impuestosBD = parseFloat(order.impuestos || 0);
            const totalRaw = parseFloat(order.total || 0);
            const TAX_RATE = 0.13;

            // Obtener información del canje de puntos si está disponible
            const rewardCanje = order.rewardCanje || null;
            let rewardType = rewardCanje ? (rewardCanje.tipo_promocion || rewardCanje.tipo) : null;

            // Calcular subtotalAfterReward desde los impuestos
            // Los impuestos se calculan sobre subtotalAfterReward: taxes = subtotalAfterReward * TAX_RATE
            const subtotalAfterReward = impuestosBD > 0 ? impuestosBD / TAX_RATE : 0;
            
            // Si rewardCanje es null pero hay descuentos, intentar detectar si es porcentaje
            // Si descuentosRecompensasBD es muy pequeño (menor a 100) y el subtotal es grande,
            // probablemente es un porcentaje guardado incorrectamente
            if (!rewardType && descuentosRecompensasBD > 0 && descuentosRecompensasBD < 100 && subtotalBD > 1000) {
                console.log('Intentando detectar si es porcentaje:', { descuentosRecompensasBD, subtotalBD, subtotalAfterReward });
                // Calcular qué porcentaje sería si descuentosRecompensasBD fuera el porcentaje
                const posiblePorcentaje = descuentosRecompensasBD / 100;
                if (subtotalAfterReward > 0 && (1 - posiblePorcentaje) > 0) {
                    const subtotalCalculado = subtotalAfterReward / (1 - posiblePorcentaje);
                    const descuentoCalculado = subtotalCalculado * posiblePorcentaje;
                    console.log('Cálculo de detección:', { posiblePorcentaje, subtotalCalculado, descuentoCalculado });
                    // Si el descuento calculado es razonable (mayor a descuentosRecompensasBD pero menor al subtotal)
                    // O si el descuento calculado es mucho mayor que descuentosRecompensasBD, definitivamente es porcentaje
                    if ((descuentoCalculado > descuentosRecompensasBD && descuentoCalculado < subtotalBD) || 
                        descuentoCalculado > descuentosRecompensasBD * 10) {
                        rewardType = 'descuento_porcentaje';
                        console.log('✓ Detectado porcentaje desde descuentosRecompensasBD:', { 
                            descuentosRecompensasBD, 
                            posiblePorcentaje, 
                            descuentoCalculado,
                            rewardType
                        });
                    } else {
                        console.log('No se detectó como porcentaje:', { 
                            descuentoCalculado, 
                            descuentosRecompensasBD, 
                            subtotalBD,
                            condicion1: descuentoCalculado > descuentosRecompensasBD,
                            condicion2: descuentoCalculado < subtotalBD,
                            condicion3: descuentoCalculado > descuentosRecompensasBD * 10
                        });
                    }
                }
            }
            
            // Calcular subtotalAfterPromotions (antes de descuento de recompensa)
            // Si es porcentaje, necesitamos calcular el subtotalAfterPromotions de otra manera
            let subtotalAfterPromotions;
            let descuentoRecompensaFinal = 0;
            
            if (rewardType === 'descuento_porcentaje') {
                // Si rewardCanje existe, usar su valor_canje, sino usar descuentosRecompensasBD como porcentaje
                const porcentajeRaw = rewardCanje && rewardCanje.valor_canje 
                    ? parseFloat(rewardCanje.valor_canje)
                    : parseFloat(descuentosRecompensasBD);
                // Si el valor es mayor a 1, asumir que es un porcentaje (ej: 10 para 10%)
                // Si es menor o igual a 1, asumir que ya está en decimal (ej: 0.10 para 10%)
                const porcentaje = porcentajeRaw > 1 ? porcentajeRaw / 100 : porcentajeRaw;
                
                console.log('Calculando descuento porcentaje:', { porcentajeRaw, porcentaje, subtotalAfterReward, subtotalBD });
                
                // Validar que el porcentaje sea válido (entre 0 y 1)
                if (porcentaje > 0 && porcentaje < 1) {
                    // Intentar calcular desde subtotalAfterReward (más preciso)
                    // subtotalAfterReward = subtotalAfterPromotions * (1 - porcentaje)
                    // Por lo tanto: subtotalAfterPromotions = subtotalAfterReward / (1 - porcentaje)
                    if (subtotalAfterReward > 0 && (1 - porcentaje) > 0) {
                        subtotalAfterPromotions = subtotalAfterReward / (1 - porcentaje);
                        descuentoRecompensaFinal = subtotalAfterPromotions * porcentaje;
                        console.log('Calculado desde subtotalAfterReward:', { subtotalAfterPromotions, descuentoRecompensaFinal });
                    } else if (subtotalBD > 0) {
                        // Si subtotalAfterReward no está disponible, usar subtotalBD como aproximación
                        // Esto es menos preciso pero mejor que usar el valor incorrecto de BD
                        subtotalAfterPromotions = subtotalBD;
                        descuentoRecompensaFinal = subtotalBD * porcentaje;
                        console.log('Calculado desde subtotalBD:', { subtotalAfterPromotions, descuentoRecompensaFinal });
                    } else {
                        // Si no hay subtotal disponible, no podemos calcular
                        subtotalAfterPromotions = 0;
                        descuentoRecompensaFinal = 0;
                        console.warn('No se pudo calcular descuento: no hay subtotal disponible');
                    }
                } else {
                    // Porcentaje inválido, intentar detectar si descuentosRecompensasBD es el porcentaje
                    console.warn('Porcentaje inválido, intentando detectar desde BD:', { porcentaje, descuentosRecompensasBD });
                    if (descuentosRecompensasBD > 0 && descuentosRecompensasBD < 100 && subtotalBD > 0) {
                        // Asumir que descuentosRecompensasBD contiene el porcentaje guardado incorrectamente
                        const porcentajeFromBD = descuentosRecompensasBD / 100;
                        if (subtotalAfterReward > 0 && (1 - porcentajeFromBD) > 0) {
                            subtotalAfterPromotions = subtotalAfterReward / (1 - porcentajeFromBD);
                            descuentoRecompensaFinal = subtotalAfterPromotions * porcentajeFromBD;
                            console.log('Recalculado desde BD (subtotalAfterReward):', { porcentajeFromBD, subtotalAfterPromotions, descuentoRecompensaFinal });
                        } else {
                            subtotalAfterPromotions = subtotalBD;
                            descuentoRecompensaFinal = subtotalBD * porcentajeFromBD;
                            console.log('Recalculado desde BD (subtotalBD):', { porcentajeFromBD, subtotalAfterPromotions, descuentoRecompensaFinal });
                        }
                    } else {
                        // No podemos calcular, usar el valor de BD directamente (esperando que sea correcto)
                        subtotalAfterPromotions = subtotalAfterReward + descuentosRecompensasBD;
                        descuentoRecompensaFinal = descuentosRecompensasBD;
                        console.warn('Usando valor de BD directamente:', { descuentoRecompensaFinal });
                    }
                }
            } else {
                // Si es colones, el descuento se restó directamente
                subtotalAfterPromotions = subtotalAfterReward + descuentosRecompensasBD;
                // El descuento ya está correcto en colones
                descuentoRecompensaFinal = descuentosRecompensasBD;
            }
            
            // Asegurar que descuentoRecompensaFinal sea un número válido y positivo
            // Si el valor es muy pequeño (menor a 1) y es un porcentaje, probablemente es incorrecto
            if (isNaN(descuentoRecompensaFinal) || descuentoRecompensaFinal < 0) {
                descuentoRecompensaFinal = 0;
            }
            
            console.log('Descuento final calculado:', { descuentoRecompensaFinal, rewardType });

            // Calcular descuentos de promociones
            const descuentosPromociones = Math.max(0, subtotalBD - subtotalAfterPromotions);

            // Preparar opciones para renderOrderSummaryHTML
            // IMPORTANTE: rewardDiscount debe ser el monto calculado en colones
            // Si es porcentaje, lo recalculamos arriba para asegurar que sea correcto
            // Para evitar que renderOrderSummaryHTML recalcule, siempre pasamos el tipo como 'descuento_colones'
            // cuando ya tenemos el rewardDiscount calculado, independientemente del tipo original
            const options = {
                deliveryFee: deliveryFee,
                taxRate: TAX_RATE,
                rewardDiscount: descuentoRecompensaFinal, // Siempre el monto calculado en colones
                activeReward: descuentoRecompensaFinal > 0 && rewardCanje ? {
                    // IMPORTANTE: Siempre pasar el descuento calculado en colones como valor_canje
                    // Y cambiar el tipo a 'descuento_colones' para evitar que renderOrderSummaryHTML recalcule
                    valor_canje: descuentoRecompensaFinal, // Siempre el monto calculado en colones
                    nombre: rewardCanje.nombre || 'Descuento por puntos',
                    // Cambiar el tipo a 'descuento_colones' para evitar recálculo
                    // renderOrderSummaryHTML usará rewardDiscount directamente cuando está definido
                    tipo: 'descuento_colones', // Forzar a colones para evitar recálculo
                    tipo_promocion: 'descuento_colones' // Forzar a colones para evitar recálculo
                } : (descuentoRecompensaFinal > 0 ? {
                    valor_canje: descuentoRecompensaFinal, // Si no hay info del canje, asumir colones
                    nombre: 'Descuento por puntos',
                    tipo: 'descuento_colones',
                    tipo_promocion: 'descuento_colones'
                } : null)
            };

            try {
                // Debug ANTES de validar
                console.log('Debug ANTES de validar:', {
                    descuentosRecompensasBD,
                    rewardType,
                    descuentoRecompensaFinal,
                    subtotalAfterReward,
                    subtotalAfterPromotions,
                    subtotalBD,
                    rewardCanje: rewardCanje ? {
                        valor_canje: rewardCanje.valor_canje,
                        tipo: rewardType
                    } : null
                });
                
                // Asegurar que descuentoRecompensaFinal sea un número válido
                // Si el valor calculado es muy pequeño (menor a 1) y rewardType es porcentaje,
                // probablemente el cálculo falló y estamos viendo el porcentaje en lugar del monto
                if (rewardType === 'descuento_porcentaje' && descuentoRecompensaFinal > 0 && descuentoRecompensaFinal < 100 && subtotalBD > 0) {
                    // Si el descuento es menor a 100, probablemente es el porcentaje guardado incorrectamente
                    // Recalcular desde subtotalBD
                    const porcentajeRaw = parseFloat(rewardCanje?.valor_canje || descuentoRecompensaFinal);
                    const porcentaje = porcentajeRaw > 1 ? porcentajeRaw / 100 : porcentajeRaw;
                    if (porcentaje > 0 && porcentaje < 1) {
                        if (subtotalAfterReward > 0) {
                            subtotalAfterPromotions = subtotalAfterReward / (1 - porcentaje);
                            descuentoRecompensaFinal = subtotalAfterPromotions * porcentaje;
                        } else {
                            descuentoRecompensaFinal = subtotalBD * porcentaje;
                        }
                        console.log('Recalculado desde porcentaje:', { porcentaje, descuentoRecompensaFinal });
                    }
                }
                
                if (isNaN(descuentoRecompensaFinal) || descuentoRecompensaFinal < 0) {
                    descuentoRecompensaFinal = 0;
                }
                
                // Actualizar options con el valor validado
                options.rewardDiscount = descuentoRecompensaFinal;
                if (options.activeReward) {
                    options.activeReward.valor_canje = descuentoRecompensaFinal;
                    // Forzar tipo a colones para evitar recálculo
                    options.activeReward.tipo = 'descuento_colones';
                    options.activeReward.tipo_promocion = 'descuento_colones';
                }
                
                // Debug: verificar valores DESPUÉS de validar
                console.log('Debug DESPUÉS de validar:', {
                    descuentosRecompensasBD,
                    rewardType,
                    descuentoRecompensaFinal,
                    subtotalAfterReward,
                    subtotalAfterPromotions,
                    subtotalBD,
                    optionsRewardDiscount: options.rewardDiscount,
                    activeRewardValorCanje: options.activeReward?.valor_canje
                });
                
                // Usar renderOrderSummaryHTML para generar el resumen
                await window.renderOrderSummaryHTML(items, 'modalOrderSummary', options);
            } catch (error) {
                console.error('Error al renderizar resumen del pedido:', error);
                // Fallback: mostrar resumen básico
                renderOrderSummaryFallback(order, summaryContainer);
            }
        }

        // Función fallback para mostrar resumen básico
        function renderOrderSummaryFallback(order, container) {
            const subtotalBD = parseFloat(order.subtotal || 0);
            const deliveryFee = 1500;
            const descuentosRecompensas = parseFloat(order.descuentos || 0);
            const impuestosBD = parseFloat(order.impuestos || 0);
            const totalRaw = parseFloat(order.total || 0);
            const TAX_RATE = 0.13;
            
            const subtotalAfterReward = impuestosBD > 0 ? impuestosBD / TAX_RATE : 0;
            const subtotalAfterPromotions = subtotalAfterReward + descuentosRecompensas;
            const descuentosPromociones = Math.max(0, subtotalBD - subtotalAfterPromotions);

            const formatPrice = (value) => {
                if (typeof window.formatPrice === 'function') {
                    return window.formatPrice(value);
                }
                return parseFloat(value || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            };

            container.innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-600">Subtotal:</span>
                    <span>₡${formatPrice(subtotalBD)}</span>
                </div>
                ${descuentosPromociones > 0.01 ? `
                    <div class="flex justify-between text-green-600 font-semibold">
                        <span>Descuentos promocionales:</span>
                        <span>-₡${formatPrice(descuentosPromociones)}</span>
                    </div>
                ` : ''}
                ${descuentosRecompensas > 0.01 ? `
                    <div class="flex justify-between text-green-600 font-semibold">
                        <span>Descuento por puntos:</span>
                        <span>-₡${formatPrice(descuentosRecompensas)}</span>
                    </div>
                ` : ''}
                <div class="flex justify-between">
                    <span class="text-gray-600">Costo de entrega:</span>
                    <span>₡${formatPrice(deliveryFee)}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Impuestos:</span>
                    <span>₡${formatPrice(impuestosBD)}</span>
                </div>
                <hr class="my-2">
                <div class="flex justify-between font-semibold text-lg">
                    <span>Total:</span>
                    <span>₡${formatPrice(totalRaw)}</span>
                </div>
            `;
        }

        // Funciones para calificar pedidos
        let pedidoActualCalificar = null;
        let calificacionesProductos = {};

        window.calificarPedido = async function calificarPedido(pedidoId) {
            console.log('calificarPedido llamado con ID:', pedidoId);
            pedidoActualCalificar = pedidoId;
            calificacionesProductos = {};
            
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Debes iniciar sesión para calificar productos',
                        confirmButtonColor: '#f97316'
                    });
                    return;
                }

                const response = await fetch(`/api/pedidos/${pedidoId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Respuesta del API:', data);
                
                // El API puede devolver data.data.pedido o data.pedido
                const pedido = data.data?.pedido || data.pedido;
                
                if (!pedido) {
                    console.error('No se encontró el pedido en la respuesta:', data);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo cargar el pedido. La respuesta no contiene datos del pedido.',
                        confirmButtonColor: '#f97316'
                    });
                    return;
                }
                
                console.log('Pedido cargado:', pedido);
                const modalContent = document.getElementById('calificarModalContent');
                
                if (!modalContent) {
                    console.error('No se encontró el elemento calificarModalContent');
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Error al cargar el modal de calificación',
                        confirmButtonColor: '#f97316'
                    });
                    return;
                }
                
                // El API devuelve productos, no items
                const productos = pedido.productos || pedido.items || [];
                console.log('Productos encontrados:', productos);
                
                // Filtrar solo productos que tienen id_producto (productos que aún existen)
                const productosCalificables = productos.filter(item => item.id_producto);
                console.log('Productos calificables:', productosCalificables);
                
                if (!productosCalificables || productosCalificables.length === 0) {
                    modalContent.innerHTML = '<p class="text-gray-600">No hay productos disponibles para calificar en este pedido.</p>';
                } else {
                    modalContent.innerHTML = productosCalificables.map((item, index) => {
                        const productoId = item.id_producto;
                        return `
                            <div class="border border-gray-200 rounded-lg p-4" data-producto-id="${productoId}">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">${item.producto_nombre || 'Producto'}</h4>
                                        <p class="text-sm text-gray-600">Cantidad: ${item.cantidad}</p>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Calificación *</label>
                                    <div class="flex gap-1 text-2xl" id="estrellas-${productoId}">
                                        ${[1,2,3,4,5].map(val => `
                                            <span class="estrella-calificar cursor-pointer text-gray-300 hover:text-yellow-400 transition" 
                                                  data-valor="${val}" 
                                                  data-producto="${productoId}"
                                                  onclick="seleccionarEstrellaCalificar(${val}, ${productoId})"
                                                  onmouseover="pintarEstrellasCalificar(${val}, ${productoId})"
                                                  onmouseout="pintarEstrellasCalificar(calificacionesProductos[${productoId}] || 0, ${productoId})">★</span>
                                        `).join('')}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Comentario (opcional)</label>
                                    <textarea id="comentario-${productoId}" 
                                              rows="2" 
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                                              placeholder="Escribe tu comentario..."></textarea>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                const modal = document.getElementById('calificarModal');
                if (!modal) {
                    console.error('No se encontró el elemento calificarModal');
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Error al abrir el modal de calificación',
                        confirmButtonColor: '#f97316'
                    });
                    return;
                }
                
                console.log('Abriendo modal de calificación');
                modal.classList.add('show');
            } catch (error) {
                console.error('Error al cargar pedido:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo cargar el pedido: ' + (error.message || 'Error desconocido'),
                    confirmButtonColor: '#f97316'
                });
            }
        }

        window.seleccionarEstrellaCalificar = function seleccionarEstrellaCalificar(valor, productoId) {
            calificacionesProductos[productoId] = valor;
            pintarEstrellasCalificar(valor, productoId);
        }

        window.pintarEstrellasCalificar = function pintarEstrellasCalificar(valor, productoId) {
            const estrellas = document.querySelectorAll(`#estrellas-${productoId} .estrella-calificar`);
            estrellas.forEach((e, index) => {
                if (index < valor) {
                    e.classList.add('text-yellow-400');
                    e.classList.remove('text-gray-300');
                } else {
                    e.classList.remove('text-yellow-400');
                    e.classList.add('text-gray-300');
                }
            });
        }

        window.cerrarModalCalificar = function cerrarModalCalificar() {
            document.getElementById('calificarModal').classList.remove('show');
            pedidoActualCalificar = null;
            calificacionesProductos = {};
        }

        //Configura los event listeners del modal de calificar
        function setupCalificarModalEventListeners() {
            const modal = document.getElementById('calificarModal');
            if (!modal) return;

            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    cerrarModalCalificar();
                }
            });

            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const calificarModal = document.getElementById('calificarModal');
                    if (calificarModal && calificarModal.classList.contains('show')) {
                        cerrarModalCalificar();
                    }
                }
            });
        }

        window.enviarCalificaciones = async function enviarCalificaciones() {
            console.log('enviarCalificaciones llamado');
            console.log('pedidoActualCalificar:', pedidoActualCalificar);
            console.log('calificacionesProductos:', calificacionesProductos);
            
            if (!pedidoActualCalificar) {
                console.error('No hay pedido actual para calificar');
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se encontró el pedido a calificar',
                    confirmButtonColor: '#f97316'
                });
                return;
            }
            
            // Obtener todos los productos del modal
            const productosEnModal = document.querySelectorAll('[data-producto-id]');
            console.log('Productos en modal:', productosEnModal.length);
            
            if (productosEnModal.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Sin productos',
                    text: 'No hay productos para calificar',
                    confirmButtonColor: '#f97316'
                });
                return;
            }
            
            // Verificar que todos los productos tengan calificación
            const productosSinCalificar = [];
            productosEnModal.forEach(productoElement => {
                const productoId = productoElement.getAttribute('data-producto-id');
                const calificacion = calificacionesProductos[productoId];
                if (!calificacion || calificacion === 0) {
                    productosSinCalificar.push(productoId);
                }
            });
            
            console.log('Productos sin calificar:', productosSinCalificar);
            
            if (productosSinCalificar.length > 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Calificación requerida',
                    text: `Por favor califica todos los productos. Faltan ${productosSinCalificar.length} producto(s) por calificar.`,
                    confirmButtonColor: '#f97316'
                });
                return;
            }
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Debes iniciar sesión para enviar calificaciones',
                    confirmButtonColor: '#f97316'
                });
                return;
            }
            
            // Preparar productos para enviar
            const productos = [];
            productosEnModal.forEach(productoElement => {
                const productoId = productoElement.getAttribute('data-producto-id');
                const comentarioElement = document.getElementById(`comentario-${productoId}`);
                productos.push({
                    id_producto: parseInt(productoId),
                    calificacion: calificacionesProductos[productoId],
                    comentario: comentarioElement ? comentarioElement.value.trim() : ''
                });
            });
            
            console.log('Productos a enviar:', productos);
            
            // Mostrar loading
            Swal.fire({
                title: 'Enviando calificaciones...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            try {
                // Enviar cada calificación
                const resultados = [];
                for (const producto of productos) {
                    console.log('Enviando calificación para producto:', producto);
                    const response = await fetch('/api/opiniones', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            id_producto: producto.id_producto,
                            calificacion: producto.calificacion,
                            comentario: producto.comentario,
                            tipo_opinion: 'producto'
                        })
                    });
                    
                    const data = await response.json();
                    console.log('Respuesta del API para producto', producto.id_producto, ':', data);
                    
                    if (!response.ok) {
                        const errorMsg = data.mensaje || data.message || `Error HTTP ${response.status}`;
                        console.error('Error HTTP al enviar calificación:', errorMsg, response.status);
                        resultados.push({
                            producto: producto.id_producto,
                            exito: false,
                            error: errorMsg
                        });
                    } else if (!data.success) {
                        const errorMsg = data.mensaje || data.message || 'Error al enviar calificación';
                        console.error('Error en respuesta del API:', errorMsg);
                        resultados.push({
                            producto: producto.id_producto,
                            exito: false,
                            error: errorMsg
                        });
                    } else {
                        console.log('Calificación enviada exitosamente para producto', producto.id_producto);
                        resultados.push({
                            producto: producto.id_producto,
                            exito: true
                        });
                    }
                }
                
                // Verificar resultados
                const fallidos = resultados.filter(r => !r.exito);
                const exitosos = resultados.filter(r => r.exito);
                
                console.log('Resultados finales:', { exitosos: exitosos.length, fallidos: fallidos.length });
                
                if (fallidos.length > 0) {
                    console.error('Algunas calificaciones fallaron:', fallidos);
                    const errores = fallidos.map(f => f.error).filter((v, i, a) => a.indexOf(v) === i);
                    const mensajeErrores = errores.length > 0 ? '\n\nErrores: ' + errores.join(', ') : '';
                    
                    Swal.fire({
                        icon: 'warning',
                        title: 'Calificaciones parcialmente enviadas',
                        html: `<p>${exitosos.length} de ${resultados.length} calificaciones se enviaron correctamente.</p>${mensajeErrores ? `<p class="text-sm text-gray-600 mt-2">${mensajeErrores}</p>` : ''}`,
                        confirmButtonColor: '#f97316'
                    });
                } else if (exitosos.length === 0) {
                    console.error('Todas las calificaciones fallaron');
                    const errores = fallidos.map(f => f.error).filter((v, i, a) => a.indexOf(v) === i);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al enviar calificaciones',
                        html: `<p>No se pudieron enviar las calificaciones.</p>${errores.length > 0 ? `<p class="text-sm text-gray-600 mt-2">Errores: ${errores.join(', ')}</p>` : ''}`,
                        confirmButtonColor: '#f97316'
                    });
                } else {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Calificaciones enviadas!',
                        text: 'Tus opiniones serán revisadas antes de ser publicadas',
                        confirmButtonColor: '#f97316'
                    });
                }
                
                // Solo cerrar el modal si todas las calificaciones fueron exitosas
                if (fallidos.length === 0) {
                    cerrarModalCalificar();
                }
            } catch (error) {
                console.error('Error al enviar calificaciones:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error de conexión: ' + (error.message || 'No se pudieron enviar las calificaciones'),
                    confirmButtonColor: '#f97316'
                });
            }
        }

    </script>
    <style>
        .estrella-calificar {
            transition: all 0.2s;
        }
    </style>
</body>
</html>
