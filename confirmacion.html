<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmación de Pedido - Sunset's Tarbaca</title>
    <link rel="icon" type="image/png" href="/sunsets_logo_b.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/navbar.js"></script>
    <script src="/js/footer.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Navbar Container -->
    <div id="navbar-container"></div>

    <!-- Confirmation Content -->
    <section class="py-12 flex-grow">
        <div class="container mx-auto px-4">
            <div class="max-w-2xl mx-auto text-center">
                <!-- Success Icon -->
                <div class="mb-8">
                    <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-check text-green-600 text-4xl"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">¡Pedido Confirmado!</h1>
                    <p class="text-lg text-gray-600 mb-8">Tu pedido ha sido recibido y está siendo preparado</p>
                </div>

                <!-- Order Details -->
                <div class="bg-white rounded-lg shadow-md p-8 mb-8">
                    <h2 class="text-xl font-semibold mb-6">Detalles del Pedido</h2>
                    
                    <div id="order-details" class="space-y-4">
                        <!-- Los detalles se cargarán dinámicamente aquí -->
                    </div>
                </div>

                <!-- Next Steps -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
                    <h3 class="text-lg font-semibold text-blue-800 mb-4">¿Qué sigue?</h3>
                    <div class="space-y-3 text-left">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-semibold">1</div>
                            <p class="text-blue-700">Recibirás un SMS de confirmación en los próximos minutos</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-semibold">2</div>
                            <p class="text-blue-700">Tu pedido será preparado en 30-45 minutos</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-semibold">3</div>
                            <p class="text-blue-700">Te notificaremos cuando el repartidor esté en camino</p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="/menu.html" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-3 rounded-lg hover:from-orange-600 hover:to-red-600 transition font-semibold flex items-center justify-center gap-2">
                        <i class="fas fa-utensils"></i>
                        Hacer Otro Pedido
                    </a>
                    <a href="/index.html" class="bg-gray-600 text-white px-8 py-3 rounded-lg hover:bg-gray-700 transition font-semibold flex items-center justify-center gap-2">
                        <i class="fas fa-home"></i>
                        Ir al Inicio
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer Container -->
    <div id="footer-container" class="mt-auto"></div>


    <script>
        let orderData = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadOrderData();
            displayOrderDetails().catch(error => console.error('Error al mostrar detalles del pedido:', error));
        });

        //Carga los datos del pedido
        function loadOrderData() {
            const savedOrderData = localStorage.getItem('sunsets-complete-order');
            if (savedOrderData) {
                orderData = JSON.parse(savedOrderData);
            } else {
                window.location.href = '/pedidos.html';
            }
        }

        //Muestra los detalles del pedido
        async function displayOrderDetails() {
            const detailsContainer = document.getElementById('order-details');
            if (!detailsContainer || !orderData) return;

            const customer = orderData.customer;
            const delivery = orderData.delivery;
            const payment = orderData.payment;

            const items = orderData.items || [];
            const orderSummaryHTML = await renderOrderSummary(orderData);
            
            detailsContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Información del Cliente</h4>
                        <p class="text-gray-600"><strong>Nombre:</strong> ${customer.name || 'No disponible'}</p>
                        <p class="text-gray-600"><strong>Teléfono:</strong> ${customer.phone || 'No disponible'}</p>
                        ${customer.email ? `<p class="text-gray-600"><strong>Email:</strong> ${customer.email}</p>` : ''}
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Dirección de Entrega</h4>
                        ${getDeliveryAddressHTML(delivery)}
                        ${delivery.instructions ? `<p class="text-gray-600 mt-2"><strong>Instrucciones:</strong> ${delivery.instructions}</p>` : ''}
                    </div>
                </div>
                
                <div class="border-t pt-4 mt-4">
                    <h4 class="font-semibold text-gray-700 mb-2">Método de Pago</h4>
                    <p class="text-gray-600">${getPaymentMethodName(payment.method)}</p>
                </div>
                
                <div class="border-t pt-4 mt-4">
                    <h4 class="font-semibold text-gray-700 mb-2">Resumen del Pedido</h4>
                    ${orderSummaryHTML}
                </div>
                
                <div class="border-t pt-4 mt-4 text-center">
                    <p class="text-sm text-gray-500">
                        <strong>Número de Pedido:</strong> ${orderData.numeroPedido || '#' + (orderData.id || 'N/A')}<br>
                        <strong>Fecha:</strong> ${new Date(orderData.timestamp || Date.now()).toLocaleString('es-CR')}
                    </p>
                </div>
            `;
        }

        //Obtiene la dirección de entrega en HTML
        function getDeliveryAddressHTML(delivery) {
            if (delivery.addressText) {
                return `<p class="text-gray-600">${delivery.addressText}</p>`;
            }
            
            if (delivery.address && delivery.district && delivery.canton && delivery.province) {
                return `
                    <p class="text-gray-600">${delivery.address}</p>
                    <p class="text-gray-600">${delivery.district}, ${delivery.canton}</p>
                    <p class="text-gray-600">${delivery.province}</p>
                `;
            }
            
            return `<p class="text-gray-600">Dirección no disponible</p>`;
        }

        //Obtiene el nombre del método de pago
        function getPaymentMethodName(method) {
            const methods = {
                'efectivo': 'Pago en Efectivo',
                'sinpe': 'SINPE Móvil'
            };
            return methods[method] || method;
        }

        let activePromotions = [];
        let promotionsLoaded = false;
        let promotionsLoadingPromise = null;

        function normalizePromotion(promo = {}) {
            const porcentaje = Number(
                promo?.porcentaje_descuento ??
                promo?.valor_descuento ??
                promo?.porcentaje ??
                promo?.valor ??
                0
            );

            let productos = [];
            if (Array.isArray(promo?.productos)) {
                productos = promo.productos
                    .map((producto) => Number(producto?.id_producto ?? producto?.id ?? producto))
                    .filter((id) => !Number.isNaN(id));
            }

            return {
                id: Number(promo?.id_promocion ?? promo?.id ?? 0),
                nombre: promo?.nombre_promocion ?? promo?.nombre ?? 'Promoción',
                descripcion: promo?.descripcion ?? '',
                alcance: promo?.alcance === 'producto' ? 'producto' : 'general',
                porcentaje: porcentaje > 0 ? porcentaje : 0,
                productos
            };
        }

        async function loadActivePromotions() {
            if (promotionsLoaded) {
                return activePromotions;
            }

            if (promotionsLoadingPromise) {
                return promotionsLoadingPromise;
            }

            promotionsLoadingPromise = (async () => {
                try {
                    const response = await fetch('/api/promociones/public/activas');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    const promociones = data?.data?.promociones || data?.promociones || [];
                    activePromotions = Array.isArray(promociones)
                        ? promociones.map(normalizePromotion).filter(promo => promo.porcentaje > 0)
                        : [];
                } catch (error) {
                    console.error('Error al cargar promociones activas:', error);
                    activePromotions = [];
                } finally {
                    promotionsLoaded = true;
                    promotionsLoadingPromise = null;
                }

                return activePromotions;
            })();

            return promotionsLoadingPromise;
        }

        function calculatePromotionsDiscount(subtotal, cartItems, promotions) {
            if (!Array.isArray(cartItems) || cartItems.length === 0 || !Array.isArray(promotions) || promotions.length === 0) {
                return { discount: 0, breakdown: [] };
            }

            const subtotalByProduct = new Map();

            cartItems.forEach((item) => {
                if (!item) return;
                const quantity = Number(item.quantity);
                const price = Number(item.price);
                if (Number.isNaN(quantity) || Number.isNaN(price) || quantity <= 0 || price < 0) {
                    return;
                }

                const lineSubtotal = price * quantity;
                const productId = Number(item.id);

                if (!Number.isNaN(productId)) {
                    subtotalByProduct.set(productId, (subtotalByProduct.get(productId) || 0) + lineSubtotal);
                }
            });

            let totalDiscount = 0;
            const breakdown = [];

            promotions.forEach((promo) => {
                if (!promo || promo.porcentaje <= 0) {
                    return;
                }

                const porcentaje = promo.porcentaje / 100;
                let applicableSubtotal = 0;

                if (promo.alcance === 'producto') {
                    if (!Array.isArray(promo.productos) || promo.productos.length === 0) {
                        return;
                    }

                    promo.productos.forEach((productId) => {
                        const subtotalProducto = subtotalByProduct.get(Number(productId));
                        if (subtotalProducto) {
                            applicableSubtotal += subtotalProducto;
                        }
                    });
                } else {
                    applicableSubtotal = subtotal;
                }

                if (applicableSubtotal <= 0) {
                    return;
                }

                const discountAmount = applicableSubtotal * porcentaje;

                if (discountAmount <= 0) {
                    return;
                }

                totalDiscount += discountAmount;
                breakdown.push({
                    label: promo.nombre,
                    amount: discountAmount,
                    alcance: promo.alcance
                });
            });

            if (totalDiscount > subtotal) {
                totalDiscount = subtotal;
            }

            return {
                discount: totalDiscount,
                breakdown
            };
        }

        async function computeFinancialBreakdown(order) {
             const items = Array.isArray(order.items) ? order.items : [];
             const subtotalFallback = items.reduce((sum, item) => {
                 const price = Number(item.price) || 0;
                 const quantity = Number(item.quantity) || 0;
                 return sum + price * quantity;
             }, 0);
 
            const subtotalRaw = Number(order.subtotal);
            const subtotal = Number.isFinite(subtotalRaw) && subtotalRaw > 0 ? subtotalRaw : subtotalFallback;

            const storedPromotionDiscount = Number(order.promotionDiscount);
            let promotionDiscount = Number.isFinite(storedPromotionDiscount) && storedPromotionDiscount > 0
                ? storedPromotionDiscount
                : 0;

            let promotionsApplied = Array.isArray(order.promotionsApplied)
                ? order.promotionsApplied.map(promo => ({
                    label: promo.label || promo.nombre || 'Descuento',
                    amount: Number(promo.amount) || Number(promo.valor) || 0,
                    alcance: promo.alcance || 'general'
                })).filter(promo => promo.amount > 0)
                : [];

            const hasStoredPromotions = promotionsApplied.length > 0;
            if (hasStoredPromotions && promotionDiscount <= 0) {
                promotionDiscount = promotionsApplied.reduce((sum, promo) => sum + (promo.amount || 0), 0);
            }

            let subtotalAfterPromotions = Number(order.subtotalAfterPromotions);
            if (!Number.isFinite(subtotalAfterPromotions) || subtotalAfterPromotions <= 0) {
                subtotalAfterPromotions = Math.max(0, subtotal - promotionDiscount);
            }

            if (!hasStoredPromotions && promotionDiscount <= 0) {
                const promotions = await loadActivePromotions();
                const { discount, breakdown } = calculatePromotionsDiscount(subtotal, items, promotions);
                promotionDiscount = discount;
                promotionsApplied = breakdown;
                subtotalAfterPromotions = Math.max(0, subtotal - promotionDiscount);
            }

            let deliveryFee = Number(order.deliveryFee);
            if (!Number.isFinite(deliveryFee)) {
                const deliveryFeeFromDelivery = Number(order.delivery?.fee);
                deliveryFee = Number.isFinite(deliveryFeeFromDelivery) ? deliveryFeeFromDelivery : deliveryFee >= 0 ? deliveryFee : 1500;
            }
            if (!Number.isFinite(deliveryFee) || deliveryFee < 0) {
                deliveryFee = 1500;
            }

            let taxes = Number(order.taxes);
            if (!Number.isFinite(taxes)) {
                taxes = subtotalAfterPromotions * 0.05;
            }

            const rewardDiscountRaw = Number(order.rewardDiscount);
            const rewardDiscount = Number.isFinite(rewardDiscountRaw) && rewardDiscountRaw > 0
                ? rewardDiscountRaw
                : Number(order.rewardCanje?.valor_canje) || 0;

            const loyaltyDiscountRaw = Number(order.loyaltyDiscount);
            const loyaltyDiscount = Number.isFinite(loyaltyDiscountRaw) && loyaltyDiscountRaw > 0
                ? loyaltyDiscountRaw
                : 0;

            const totalRaw = Number(order.total);
            const total = Number.isFinite(totalRaw) && totalRaw >= 0
                ? totalRaw
                : Math.max(0, subtotalAfterPromotions + deliveryFee + taxes - rewardDiscount - loyaltyDiscount);
 
            return {
                items,
                subtotal,
                promotionDiscount,
                promotionsLines: promotionsApplied,
                deliveryFee,
                taxes,
                rewardDiscount,
                loyaltyDiscount,
                total
            };
        }

        async function renderOrderSummary(order) {
            try {
                const breakdown = await computeFinancialBreakdown(order);
                const {
                    items,
                    subtotal,
                    promotionDiscount,
                    promotionsLines,
                    deliveryFee,
                    taxes,
                    rewardDiscount,
                    loyaltyDiscount,
                    total
                } = breakdown;

                if (items.length === 0) {
                    return '<p class="text-gray-500 text-center py-4">No hay items disponibles</p>';
                }

                const itemsHTML = items.map(item => `
                    <div class="flex justify-between">
                        <span class="text-gray-600">${item.name || `Producto #${item.id}`} x${item.quantity}</span>
                        <span>₡${(item.price * item.quantity).toLocaleString()}</span>
                    </div>
                `).join('');

                const promotionsHTML = renderPromotionsSection({ promotionsApplied: promotionsLines, promotionDiscount }, promotionDiscount);
                const rewardsLoyaltyHTML = renderRewardsAndLoyalty({ rewardDiscount, loyaltyDiscount }, rewardDiscount, loyaltyDiscount);

                return `
                    <div class="space-y-2">
                        ${itemsHTML}
                        <hr class="my-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Subtotal</span>
                            <span>₡${subtotal.toLocaleString()}</span>
                        </div>
                        ${promotionsHTML}
                        <div class="flex justify-between">
                            <span class="text-gray-600">Costo de entrega</span>
                            <span>₡${deliveryFee.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Impuestos</span>
                            <span>₡${Math.round(taxes).toLocaleString()}</span>
                        </div>
                        ${rewardsLoyaltyHTML}
                        <hr class="my-2">
                        <div class="flex justify-between font-semibold text-lg">
                            <span>Total</span>
                            <span>₡${Math.round(total).toLocaleString()}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error al renderizar resumen del pedido en confirmación:', error);
                return renderFallbackSummaryHTML(order);
            }
        }

        function renderFallbackSummaryHTML(order) {
            const items = Array.isArray(order.items) ? order.items : [];
            if (items.length === 0) {
                return '<p class="text-gray-500 text-center py-4">No hay items disponibles</p>';
            }

            const subtotal = items.reduce((sum, item) => sum + ((Number(item.price) || 0) * (Number(item.quantity) || 0)), 0);
            const deliveryFee = Number(order.deliveryFee) || 1500;
            const taxes = Number(order.taxes) || Math.round(subtotal * 0.05);
            const rewardDiscount = Number(order.rewardDiscount) || 0;
            const loyaltyDiscount = Number(order.loyaltyDiscount) || 0;
            const total = Math.max(0, subtotal + deliveryFee + taxes - rewardDiscount - loyaltyDiscount);

            const itemsHTML = items.map(item => `
                <div class="flex justify-between">
                    <span class="text-gray-600">${item.name || `Producto #${item.id}`} x${item.quantity}</span>
                    <span>₡${(item.price * item.quantity).toLocaleString()}</span>
                </div>
            `).join('');

            const rewardRow = rewardDiscount > 0 ? `
                <div class="flex justify-between text-green-600 font-semibold">
                    <span>Descuento por recompensa</span>
                    <span>-₡${Math.round(rewardDiscount).toLocaleString()}</span>
                </div>
            ` : '';

            const loyaltyRow = loyaltyDiscount > 0 ? `
                <div class="flex justify-between text-green-600 font-semibold">
                    <span>Descuento por puntos de lealtad</span>
                    <span>-₡${Math.round(loyaltyDiscount).toLocaleString()}</span>
                </div>
            ` : '';

            return `
                <div class="space-y-2">
                    ${itemsHTML}
                    <hr class="my-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Subtotal</span>
                        <span>₡${subtotal.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Costo de entrega</span>
                        <span>₡${deliveryFee.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Impuestos</span>
                        <span>₡${Math.round(taxes).toLocaleString()}</span>
                    </div>
                    ${rewardRow}
                    ${loyaltyRow}
                    <hr class="my-2">
                    <div class="flex justify-between font-semibold text-lg">
                        <span>Total</span>
                        <span>₡${Math.round(total).toLocaleString()}</span>
                    </div>
                </div>
            `;
        }

        function renderPromotionsSection(order, promotionDiscountOverride) {
            const promotions = order.promotionsApplied || [];
            const promotionDiscount = Number(promotionDiscountOverride ?? order.promotionDiscount) || 0;

            if ((!Array.isArray(promotions) || promotions.length === 0) && promotionDiscount <= 0) {
                return '';
            }

            const lines = [];

            if (Array.isArray(promotions) && promotions.length > 0) {
                promotions.forEach((promo) => {
                    if (!promo) return;
                    const label = promo.label || 'Descuento';
                    const amount = Number(promo.amount) || 0;
                    if (amount <= 0) return;
                    lines.push(`
                        <div class="flex justify-between text-green-600 font-semibold">
                            <span>${label}</span>
                            <span>-₡${Math.round(amount).toLocaleString()}</span>
                        </div>
                    `);
                });
            } else if (promotionDiscount > 0) {
                lines.push(`
                    <div class="flex justify-between text-green-600 font-semibold">
                        <span>Descuento promocional</span>
                        <span>-₡${Math.round(promotionDiscount).toLocaleString()}</span>
                    </div>
                `);
            }

            return lines.join('');
        }

        function renderRewardsAndLoyalty(order, rewardDiscountOverride, loyaltyDiscountOverride) {
            const lines = [];
            const rewardDiscount = Number(rewardDiscountOverride ?? order.rewardDiscount) || 0;
            const loyaltyDiscount = Number(loyaltyDiscountOverride ?? order.loyaltyDiscount) || 0;

            if (rewardDiscount > 0) {
                lines.push(`
                    <div class="flex justify-between text-green-600 font-semibold">
                        <span>Descuento por recompensa</span>
                        <span>-₡${Math.round(rewardDiscount).toLocaleString()}</span>
                    </div>
                `);
            }

            if (loyaltyDiscount > 0) {
                lines.push(`
                    <div class="flex justify-between text-green-600 font-semibold">
                        <span>Descuento por puntos de lealtad</span>
                        <span>-₡${Math.round(loyaltyDiscount).toLocaleString()}</span>
                    </div>
                `);
            }

            return lines.join('');
        }

    </script>
</body>
</html>
