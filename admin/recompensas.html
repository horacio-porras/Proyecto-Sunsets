<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recompensas - Sunset's Tarbaca</title>
    <link rel="icon" type="image/png" href="/sunsets_logo_b.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/navbar.js"></script>
    <script src="/js/routeProtection.js"></script>
    <script src="/js/footer.js"></script>
    <style>
        .toggle-checkbox {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }

        .toggle-checkbox input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-checkbox span {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 9999px;
            background-color: #d1d5db;
            transition: background-color 0.25s ease;
        }

        .toggle-checkbox span::after {
            content: '';
            position: absolute;
            height: 22px;
            width: 22px;
            left: 3px;
            top: 3px;
            border-radius: 9999px;
            background-color: #fff;
            transition: transform 0.25s ease;
        }

        .toggle-checkbox input:checked + span {
            background: linear-gradient(to right, #f97316, #ef4444);
        }

        .toggle-checkbox input:checked + span::after {
            transform: translateX(24px);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background-color: rgba(17, 24, 39, 0.55);
            backdrop-filter: blur(6px);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fff;
            border-radius: 1rem;
            width: 100%;
            max-width: 650px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.35);
            animation: modalSlideUp 0.25s ease-out;
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        html, body {
            min-height: 100vh;
        }
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        #navbar-container,
        #footer-container {
            flex-shrink: 0;
        }
        .main-content {
            flex: 1 0 auto;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="navbar-container"></div>

    <div class="main-content">
        <div class="container mx-auto px-4 py-8">
            <div class="bg-gray-800 text-white rounded-lg shadow-lg p-6 mb-8">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h1 class="text-3xl font-bold mb-2 flex items-center gap-3">
                            <i class="fas fa-gift text-white"></i>
                            Programa de Recompensas
                        </h1>
                        <p class="text-gray-200">Gestiona las recompensas y beneficios del programa de lealtad</p>
                    </div>
                    <div class="flex gap-4">
                        <div class="bg-white bg-opacity-10 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold" id="totalRecompensas">-</div>
                            <div class="text-sm text-gray-300">Recompensas activas</div>
                        </div>
                        <div class="bg-white bg-opacity-10 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold" id="totalCanjeables">-</div>
                            <div class="text-sm text-gray-300">Disponibles hoy</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800">Catálogo de Recompensas</h2>
                        <p class="text-sm text-gray-500">Crea y administra beneficios para el programa de lealtad.</p>
                    </div>
                    <div class="flex flex-wrap gap-3 justify-end">
                        <button id="btnNuevaRecompensa" class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-200 shadow-lg hover:shadow-xl flex items-center gap-2">
                            <i class="fas fa-plus"></i>
                            Nueva Recompensa
                        </button>
                    </div>
                </div>
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                    <div class="md:col-span-2 xl:col-span-2">
                        <div class="relative">
                            <input type="text" id="buscarRecompensa" placeholder="Buscar recompensa..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 w-full">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                    </div>
                    <div>
                        <select id="filtroTipoRecompensa" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="">Todos los tipos</option>
                            <option value="descuento_colones">Descuento en colones</option>
                            <option value="descuento_porcentaje">Descuento en porcentaje</option>
                        </select>
                    </div>
                    <div>
                        <select id="filtroEstadoRecompensa" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="">Todos los estados</option>
                            <option value="activa">Activas</option>
                            <option value="inactiva">Inactivas</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full baud table-auto">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-semibold">Recompensa</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold">Tipo</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold">Valor</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold">Puntos</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold">Vigencia</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold">Estado</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaRecompensas" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="text-center py-10 text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Cargando recompensas...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="recompensasPaginationControls" class="hidden mt-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div id="recompensasPaginationSummary" class="text-sm text-gray-600">
                    Mostrando 0 - 0 de 0 recompensas
                </div>
                <div class="flex items-center gap-2">
                    <button id="recompensasPrevPageBtn" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-left mr-1"></i> Anterior
                    </button>
                    <div id="recompensasPaginationInfo" class="text-sm font-semibold text-gray-700">
                        Página 1 de 1
                    </div>
                    <button id="recompensasNextPageBtn" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        Siguiente <i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="recompensaModal" class="modal">
        <div class="modal-content p-6 max-w-3xl">
            <div class="flex items-start justify-between pb-4 border-b border-gray-200">
                <div>
                    <h3 id="modalRecompensaTitulo" class="text-xl font-semibold text-gray-800">Nueva Recompensa</h3>
                    <p class="text-sm text-gray-500">Define beneficios y premios para tus clientes frecuentes.</p>
                </div>
                <button class="text-gray-500 hover:text-gray-700" id="btnCerrarModalRecompensa">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="formRecompensa" class="mt-4 space-y-5">
                <input type="hidden" id="recompensaId">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de la recompensa *</label>
                    <input type="text" id="nombreRecompensa" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Ej: 1500 pts en descuento">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>
                    <textarea id="descripcionRecompensa" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Describe la recompensa y cómo aprovecharla..."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de recompensa *</label>
                        <select id="tipoRecompensa" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="descuento_colones">Descuento en colones (₡)</option>
                            <option value="descuento_porcentaje">Descuento en porcentaje (%)</option>
                        </select>
                    </div>
                    <div>
                        <label id="valorRecompensaLabel" class="block text-sm font-medium text-gray-700 mb-2">Valor estimado (₡)</label>
                        <input type="number" id="valorRecompensa" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Ej: 5000">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Puntos requeridos *</label>
                        <input type="number" id="puntosRequeridosRecompensa" min="0" step="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Ej: 450">
                    </div>
                    <div class="flex items-center justify-between mt-2 md:mt-8">
                        <span class="text-sm font-medium text-gray-700">Recompensa activa</span>
                        <label class="toggle-checkbox">
                            <input type="checkbox" id="recompensaActiva" checked>
                            <span></span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de inicio</label>
                        <input type="datetime-local" id="fechaInicioRecompensa" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de fin</label>
                        <input type="datetime-local" id="fechaFinRecompensa" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                    <button type="submit" id="btnGuardarRecompensa" class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-6 py-3 rounded-lg hover:from-orange-600 hover:to-red-600 transition font-semibold flex items-center gap-2">
                        <i id="btnGuardarRecompensaIcon" class="fas fa-plus"></i>
                        <span id="btnGuardarRecompensaTexto">Agregar</span>
                        <i id="btnGuardarRecompensaSpinner" class="fas fa-spinner fa-spin hidden"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="footer-container"></div>

    <script>
        let recompensas = [];
        let recompensaEditando = null;
        let recompensasFiltradas = [];
        let recompensasPaginaActual = 1;
        const RECOMPENSAS_POR_PAGINA = 10;

        let recompensasPaginationControls;
        let recompensasPaginationSummary;
        let recompensasPaginationInfo;
        let recompensasPrevPageBtn;
        let recompensasNextPageBtn;

        document.addEventListener('DOMContentLoaded', () => {
            loadNavbar();
            inicializarControlesPaginacionRecompensas();
            loadRecompensas();
            setupRecompensasListeners();
        });

        function inicializarControlesPaginacionRecompensas() {
            recompensasPaginationControls = document.getElementById('recompensasPaginationControls');
            recompensasPaginationSummary = document.getElementById('recompensasPaginationSummary');
            recompensasPaginationInfo = document.getElementById('recompensasPaginationInfo');
            recompensasPrevPageBtn = document.getElementById('recompensasPrevPageBtn');
            recompensasNextPageBtn = document.getElementById('recompensasNextPageBtn');

            if (recompensasPrevPageBtn) {
                recompensasPrevPageBtn.addEventListener('click', () => cambiarPaginaRecompensas(-1));
            }

            if (recompensasNextPageBtn) {
                recompensasNextPageBtn.addEventListener('click', () => cambiarPaginaRecompensas(1));
            }
        }

        function setupRecompensasListeners() {
            const btnNuevaRecompensa = document.getElementById('btnNuevaRecompensa');
            const btnCancelarRecompensa = document.getElementById('btnCancelarRecompensa');
            const btnCerrarModal = document.getElementById('btnCerrarModalRecompensa');
            const formRecompensa = document.getElementById('formRecompensa');
            const tipoRecompensa = document.getElementById('tipoRecompensa');

            if (btnNuevaRecompensa) {
                btnNuevaRecompensa.addEventListener('click', () => abrirModalRecompensa());
            }

            if (btnCancelarRecompensa) {
                btnCancelarRecompensa.addEventListener('click', cerrarModalRecompensa);
            }

            if (btnCerrarModal) {
                btnCerrarModal.addEventListener('click', cerrarModalRecompensa);
            }

            window.addEventListener('click', (event) => {
                const modal = document.getElementById('recompensaModal');
                if (event.target === modal) {
                    cerrarModalRecompensa();
                }
            });

            if (formRecompensa) {
                formRecompensa.addEventListener('submit', handleSubmitRecompensa);
            }

            if (tipoRecompensa) {
                tipoRecompensa.addEventListener('change', actualizarEtiquetaValorRecompensa);
                actualizarEtiquetaValorRecompensa();
            }

            const buscador = document.getElementById('buscarRecompensa');
            const filtroTipo = document.getElementById('filtroTipoRecompensa');
            const filtroEstado = document.getElementById('filtroEstadoRecompensa');

            if (buscador) {
                buscador.addEventListener('input', aplicarFiltros);
            }

            if (filtroTipo) {
                filtroTipo.addEventListener('change', aplicarFiltros);
            }

            if (filtroEstado) {
                filtroEstado.addEventListener('change', aplicarFiltros);
            }
        }

        function aplicarFiltros() {
            const termino = (document.getElementById('buscarRecompensa')?.value || '').toLowerCase();
            const tipoFiltro = document.getElementById('filtroTipoRecompensa')?.value || '';
            const estadoFiltro = document.getElementById('filtroEstadoRecompensa')?.value || '';

            recompensasFiltradas = recompensas.filter(recompensa => {
                const coincideBusqueda = recompensa.nombre_recompensa.toLowerCase().includes(termino) ||
                    (recompensa.descripcion || '').toLowerCase().includes(termino);

                const coincideTipo = !tipoFiltro || recompensa.tipo_recompensa === tipoFiltro;
                const coincideEstado = !estadoFiltro ||
                    (estadoFiltro === 'activa' && recompensa.activa) ||
                    (estadoFiltro === 'inactiva' && !recompensa.activa);

                return coincideBusqueda && coincideTipo && coincideEstado;
            });

            recompensasPaginaActual = 1; // Resetear a la primera página al aplicar filtros
            renderRecompensas();
        }

        async function loadRecompensas() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No se encontró token de autenticación');
                }

                const response = await fetch('/api/recompensas', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('No se pudieron cargar las recompensas');
                }

                const data = await response.json();
                 if (!data.success) {
                     throw new Error(data.message || 'No se pudieron cargar las recompensas');
                 }
 
                recompensas = data.data?.recompensas || [];
                recompensasFiltradas = [...recompensas];
                recompensasPaginaActual = 1;
                aplicarFiltros();
            } catch (error) {
                console.error('Error al cargar recompensas:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'No se pudieron cargar las recompensas.'
                });
                recompensas = [];
                recompensasFiltradas = [];
                recompensasPaginaActual = 1;
                renderRecompensas();
            }
        }

        function renderRecompensas() {
            const tbody = document.getElementById('tablaRecompensas');
            const totalRecompensas = document.getElementById('totalRecompensas');
            const totalCanjeables = document.getElementById('totalCanjeables');

            if (!tbody) return;

            if (totalRecompensas) {
                totalRecompensas.textContent = recompensas.filter(r => r.activa).length;
            }
            if (totalCanjeables) {
                totalCanjeables.textContent = recompensas.filter(r => r.disponible).length;
            }

            if (!recompensasFiltradas || recompensasFiltradas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-10 text-gray-500">
                            <i class="fas fa-gift text-4xl mb-3 text-gray-300"></i>
                            <p class="text-lg font-medium">No hay recompensas registradas</p>
                            <p class="text-gray-500">Crea una nueva recompensa para premiar a tus clientes.</p>
                        </td>
                    </tr>
                `;
                if (recompensasPaginationControls) {
                    recompensasPaginationControls.classList.add('hidden');
                }
                return;
            }

            const totalRecs = recompensasFiltradas.length;
            const totalPaginas = Math.ceil(totalRecs / RECOMPENSAS_POR_PAGINA) || 1;

            if (recompensasPaginaActual > totalPaginas) {
                recompensasPaginaActual = totalPaginas;
            }
            if (recompensasPaginaActual < 1) {
                recompensasPaginaActual = 1;
            }

            const inicio = (recompensasPaginaActual - 1) * RECOMPENSAS_POR_PAGINA;
            const fin = Math.min(inicio + RECOMPENSAS_POR_PAGINA, totalRecs);
            const recompensasPagina = recompensasFiltradas.slice(inicio, fin);

            tbody.innerHTML = recompensasPagina.map(recompensa => {
                const tipoBadgeClass = getTipoRecompensaBadge(recompensa.tipo_recompensa);
                const valorTexto = formatValorRecompensa(recompensa);
                const puntosTexto = `${(recompensa.puntos_requeridos || 0).toLocaleString()} pts`;
                const vigenciaTexto = recompensa.vigencia || 'Sin límite definido';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="font-semibold text-gray-800">${recompensa.nombre_recompensa}</div>
                            <div class="text-sm text-gray-500">${recompensa.descripcion || '—'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${tipoBadgeClass}">
                                ${formatTipoRecompensa(recompensa.tipo_recompensa)}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-700">
                            ${valorTexto}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-700">
                            ${puntosTexto}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-700">
                            ${vigenciaTexto}
                        </td>
                        <td class="px-6 py-4 text-center">
                            <label class="toggle-checkbox inline-flex items-center">
                                <input type="checkbox" ${recompensa.activa ? 'checked' : ''} onchange="toggleRecompensaActiva(${recompensa.id_recompensa}, this.checked)">
                                <span></span>
                            </label>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <button class="px-3 py-1.5 text-sm text-indigo-600 bg-indigo-50 rounded-md hover:bg-indigo-100 transition font-semibold" onclick="editarRecompensa(${recompensa.id_recompensa})">
                                    <i class="fas fa-edit mr-1"></i> Editar
                                </button>
                                <button class="px-3 py-1.5 text-sm text-red-600 bg-red-50 rounded-md hover:bg-red-100 transition font-semibold" onclick="eliminarRecompensa(${recompensa.id_recompensa})">
                                    <i class="fas fa-trash mr-1"></i> Eliminar
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            renderizarControlesPaginacionRecompensas(totalRecs, inicio, fin, totalPaginas);
        }

        function renderizarControlesPaginacionRecompensas(totalRecs, inicio, fin, totalPaginas) {
            if (!recompensasPaginationControls || !recompensasPaginationSummary || !recompensasPaginationInfo || !recompensasPrevPageBtn || !recompensasNextPageBtn) {
                return;
            }

            recompensasPaginationControls.classList.remove('hidden');

            recompensasPrevPageBtn.disabled = recompensasPaginaActual === 1;
            recompensasNextPageBtn.disabled = recompensasPaginaActual === totalPaginas || totalPaginas === 0;

            recompensasPaginationSummary.textContent = `Mostrando ${startOfPage(totalRecs)} - ${endOfPage(totalRecs)} de ${totalRecs} recompensas`;
            recompensasPaginationInfo.textContent = `Página ${recompensasPaginaActual} de ${totalPaginas}`;
        }

        function startOfPage(totalItems) {
            return (recompensasPaginaActual - 1) * RECOMPENSAS_POR_PAGINA + 1;
        }

        function endOfPage(totalItems) {
            const end = recompensasPaginaActual * RECOMPENSAS_POR_PAGINA;
            return end > totalItems ? totalItems : end;
        }

        function abrirModalRecompensa(recompensa = null) {
            recompensaEditando = recompensa;
            const modal = document.getElementById('recompensaModal');

            if (!modal) return;

            resetFormularioRecompensa();

            if (recompensa) {
                document.getElementById('modalRecompensaTitulo').textContent = 'Editar recompensa';
                document.getElementById('recompensaId').value = recompensa.id_recompensa;
                document.getElementById('nombreRecompensa').value = recompensa.nombre_recompensa || '';
                document.getElementById('descripcionRecompensa').value = recompensa.descripcion || '';
                // Convertir tipos antiguos a los nuevos para compatibilidad
                let tipoRecompensa = recompensa.tipo_recompensa || 'descuento_colones';
                if (tipoRecompensa === 'descuento' || tipoRecompensa === 'producto' || tipoRecompensa === 'experiencia') {
                    // Si es un tipo antiguo, convertirlo a descuento_colones por defecto
                    tipoRecompensa = 'descuento_colones';
                }
                document.getElementById('tipoRecompensa').value = tipoRecompensa;
                document.getElementById('valorRecompensa').value = recompensa.valor_recompensa != null ? recompensa.valor_recompensa : '';
                document.getElementById('puntosRequeridosRecompensa').value = recompensa.puntos_requeridos || 0;
                document.getElementById('fechaInicioRecompensa').value = formatoFechaParaInput(recompensa.fecha_inicio);
                document.getElementById('fechaFinRecompensa').value = formatoFechaParaInput(recompensa.fecha_fin);
                document.getElementById('recompensaActiva').checked = !!recompensa.activa;
                actualizarEtiquetaValorRecompensa();
                actualizarBotonGuardarRecompensa(true);
            } else {
                document.getElementById('modalRecompensaTitulo').textContent = 'Nueva recompensa';
                document.getElementById('recompensaActiva').checked = true;
                actualizarEtiquetaValorRecompensa();
                actualizarBotonGuardarRecompensa(false);
            }

            modal.classList.add('show');
        }

        function cerrarModalRecompensa() {
            const modal = document.getElementById('recompensaModal');
            if (modal) {
                modal.classList.remove('show');
            }
            recompensaEditando = null;
            actualizarBotonGuardarRecompensa(false);
        }

        function resetFormularioRecompensa() {
            const form = document.getElementById('formRecompensa');
            if (form) {
                form.reset();
            }
            document.getElementById('recompensaId').value = '';
            document.getElementById('recompensaActiva').checked = true;
            document.getElementById('tipoRecompensa').value = 'descuento_colones';
            actualizarEtiquetaValorRecompensa();
        }

        function actualizarBotonGuardarRecompensa(esEdicion) {
            const icono = document.getElementById('btnGuardarRecompensaIcon');
            const texto = document.getElementById('btnGuardarRecompensaTexto');
            if (!icono || !texto) return;

            if (esEdicion) {
                icono.className = 'fas fa-edit';
                texto.textContent = 'Actualizar';
            } else {
                icono.className = 'fas fa-plus';
                texto.textContent = 'Agregar';
            }
        }

        function actualizarEtiquetaValorRecompensa() {
            const tipo = document.getElementById('tipoRecompensa')?.value || 'descuento_colones';
            const label = document.getElementById('valorRecompensaLabel');
            const input = document.getElementById('valorRecompensa');

            if (!label || !input) return;

            if (tipo === 'descuento_colones') {
                label.textContent = 'Valor del descuento (₡) *';
                input.placeholder = 'Ej: 2500';
                input.disabled = false;
            } else if (tipo === 'descuento_porcentaje') {
                label.textContent = 'Valor del descuento (%) *';
                input.placeholder = 'Ej: 15';
                input.disabled = false;
            } else {
                label.textContent = 'Valor del descuento *';
                input.placeholder = 'Ej: 2500 o 15';
                input.disabled = false;
            }
        }

        function formatoFechaParaInput(fecha) {
            if (!fecha) return '';
            const date = new Date(fecha);
            if (Number.isNaN(date.getTime())) return '';
            const offset = date.getTimezoneOffset();
            const localDate = new Date(date.getTime() - (offset * 60 * 1000));
            return localDate.toISOString().slice(0, 16);
        }

        async function handleSubmitRecompensa(event) {
            event.preventDefault();

            const btnGuardar = document.getElementById('btnGuardarRecompensa');
            const spinner = document.getElementById('btnGuardarRecompensaSpinner');
            const textoBtn = document.getElementById('btnGuardarRecompensaTexto');
            if (btnGuardar && spinner && textoBtn) {
                btnGuardar.disabled = true;
                spinner.classList.remove('hidden');
                textoBtn.textContent = recompensaEditando ? 'Actualizando...' : 'Guardando...';
            }

            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No se encontró token de autenticación');
                }

                const payload = {
                    nombreRecompensa: document.getElementById('nombreRecompensa').value,
                    descripcion: document.getElementById('descripcionRecompensa').value,
                    tipoRecompensa: document.getElementById('tipoRecompensa').value,
                    valorRecompensa: document.getElementById('valorRecompensa').value,
                    puntosRequeridos: document.getElementById('puntosRequeridosRecompensa').value,
                    fechaInicio: document.getElementById('fechaInicioRecompensa').value,
                    fechaFin: document.getElementById('fechaFinRecompensa').value,
                    activa: document.getElementById('recompensaActiva').checked
                };

                const options = {
                    method: recompensaEditando ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                };

                const url = recompensaEditando
                    ? `/api/recompensas/${recompensaEditando.id_recompensa}`
                    : '/api/recompensas';

                const response = await fetch(url, options);
                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'No se pudo guardar la recompensa');
                }

                Swal.fire({
                    icon: 'success',
                    title: recompensaEditando ? 'Recompensa actualizada' : 'Recompensa creada',
                    timer: 1800,
                    showConfirmButton: false
                });

                cerrarModalRecompensa();
                await loadRecompensas();
            } catch (error) {
                console.error('Error al guardar recompensa:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'No se pudo guardar la recompensa.'
                });
            } finally {
                if (btnGuardar && spinner) {
                    btnGuardar.disabled = false;
                    spinner.classList.add('hidden');
                }
                actualizarBotonGuardarRecompensa(!!recompensaEditando);
            }
        }

        async function toggleRecompensaActiva(idRecompensa, activa) {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No se encontró token de autenticación');
                }

                const response = await fetch(`/api/recompensas/${idRecompensa}/estado`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ activa })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'No se pudo actualizar el estado');
                }

                Swal.fire({
                    icon: 'success',
                    title: `Recompensa ${activa ? 'activada' : 'desactivada'}`,
                    timer: 1400,
                    showConfirmButton: false
                });

                await loadRecompensas();
            } catch (error) {
                console.error('Error al cambiar estado de recompensa:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'No se pudo actualizar el estado de la recompensa.'
                });
            }
        }

        function editarRecompensa(idRecompensa) {
            const recompensa = recompensas.find(r => r.id_recompensa === idRecompensa);
            if (!recompensa) {
                Swal.fire({
                    icon: 'error',
                    title: 'No encontrado',
                    text: 'No se pudo encontrar la recompensa seleccionada.'
                });
                return;
            }

            abrirModalRecompensa(recompensa);
        }

        async function eliminarRecompensa(idRecompensa) {
            const recompensa = recompensas.find(r => r.id_recompensa === idRecompensa);
            if (!recompensa) {
                Swal.fire({
                    icon: 'error',
                    title: 'No encontrada',
                    text: 'No se pudo encontrar la recompensa seleccionada.'
                });
                return;
            }

            const confirmacion = await Swal.fire({
                title: '¿Eliminar recompensa?',
                text: `Se eliminará "${recompensa.nombre_recompensa}" y no podrás deshacerlo.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            });

            if (!confirmacion.isConfirmed) {
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No se encontró token de autenticación');
                }

                const response = await fetch(`/api/recompensas/${idRecompensa}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'No se pudo eliminar la recompensa');
                }

                Swal.fire({
                    icon: 'success',
                    title: 'Recompensa eliminada',
                    timer: 1400,
                    showConfirmButton: false
                });

                await loadRecompensas();
            } catch (error) {
                console.error('Error al eliminar recompensa:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'No se pudo eliminar la recompensa.'
                });
            }
        }

        function getTipoRecompensaBadge(tipo) {
            switch (tipo) {
                case 'descuento_colones':
                    return 'bg-green-100 text-green-700';
                case 'descuento_porcentaje':
                    return 'bg-blue-100 text-blue-700';
                case 'descuento':
                    // Compatibilidad con tipos antiguos
                    return 'bg-green-100 text-green-700';
                default:
                    return 'bg-gray-100 text-gray-600';
            }
        }

        function formatTipoRecompensa(tipo) {
            switch (tipo) {
                case 'descuento_colones':
                    return 'Descuento (₡)';
                case 'descuento_porcentaje':
                    return 'Descuento (%)';
                case 'descuento':
                    // Compatibilidad con tipos antiguos
                    return 'Descuento';
                default:
                    return 'Recompensa';
            }
        }

        function formatValorRecompensa(recompensa) {
            if (recompensa.valor_recompensa == null) {
                return recompensa.tipo_recompensa === 'descuento' || recompensa.tipo_recompensa === 'descuento_colones' || recompensa.tipo_recompensa === 'descuento_porcentaje'
                    ? 'Aplicar descuento al pagar'
                    : '—';
            }

            if (recompensa.tipo_recompensa === 'descuento_colones') {
                return `₡${recompensa.valor_recompensa.toLocaleString()}`;
            }

            if (recompensa.tipo_recompensa === 'descuento_porcentaje') {
                return `${recompensa.valor_recompensa.toLocaleString()}%`;
            }

            // Compatibilidad con tipos antiguos
            if (recompensa.tipo_recompensa === 'descuento') {
                return `Valor: ${recompensa.valor_recompensa.toLocaleString()} (₡ o % según el caso)`;
            }

            return `₡${parseFloat(recompensa.valor_recompensa).toLocaleString()}`;
        }

        window.toggleRecompensaActiva = toggleRecompensaActiva;
        window.editarRecompensa = editarRecompensa;
        window.eliminarRecompensa = eliminarRecompensa;

        function cambiarPaginaRecompensas(offset) {
            irAPaginaRecompensas(recompensasPaginaActual + offset);
        }

        function irAPaginaRecompensas(pagina) {
            const totalPaginas = Math.ceil((recompensasFiltradas?.length || 0) / RECOMPENSAS_POR_PAGINA) || 1;
            if (pagina < 1 || pagina > totalPaginas) {
                return;
            }
            recompensasPaginaActual = pagina;
            renderRecompensas();
        }

        function renderizarControlesPaginacionRecompensas(totalRecs, inicio, fin, totalPaginas) {
            if (!recompensasPaginationControls || !recompensasPaginationSummary || !recompensasPaginationInfo || !recompensasPrevPageBtn || !recompensasNextPageBtn) {
                return;
            }

            if (totalRecs === 0) {
                recompensasPaginationControls.classList.add('hidden');
                return;
            }

            recompensasPaginationControls.classList.remove('hidden');

            recompensasPaginationSummary.textContent = `Mostrando ${inicio + 1} - ${fin} de ${totalRecs} recompensas`;
            recompensasPaginationInfo.textContent = `Página ${recompensasPaginaActual} de ${totalPaginas}`;

            recompensasPrevPageBtn.disabled = recompensasPaginaActual <= 1;
            recompensasNextPageBtn.disabled = recompensasPaginaActual >= totalPaginas;
        }

        window.cambiarPaginaRecompensas = cambiarPaginaRecompensas;
    </script>
</body>
</html>

