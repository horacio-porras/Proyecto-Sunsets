<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Cambios - Sunset's Tarbaca</title>
    <link rel="icon" type="image/png" href="/sunsets_logo_b.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/navbar.js"></script>
    <script src="/js/routeProtection.js"></script>
    <script src="/js/footer.js"></script>
    <style>
        html, body {
            height: 100%;
        }

        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .main-content > .container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .accion-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
        }

        .accion-create { background-color: #dcfce7; color: #166534; }
        .accion-update { background-color: #dbeafe; color: #1e40af; }
        .accion-delete { background-color: #fecaca; color: #dc2626; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="navbar-container"></div>

    <div class="main-content">
        <div class="container mx-auto px-4 py-8 min-h-full">
            <div class="bg-gray-800 text-white rounded-lg shadow-lg p-6 mb-8">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h1 class="text-3xl font-bold mb-2">
                            <i class="fas fa-history mr-3"></i>Historial de Cambios
                        </h1>
                        <p class="text-gray-300">Registro de auditoría de todas las modificaciones en el sistema</p>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex flex-col md:flex-row md:items-center gap-4 flex-wrap">
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-gray-700">Tabla:</label>
                        <select id="tablaFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="">Todas las tablas</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-gray-700">Acción:</label>
                        <select id="accionFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="">Todas las acciones</option>
                            <option value="CREATE">Crear</option>
                            <option value="UPDATE">Actualizar</option>
                            <option value="DELETE">Eliminar</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-gray-700">Fecha desde:</label>
                        <input type="date" id="fechaDesde" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-gray-700">Fecha hasta:</label>
                        <input type="date" id="fechaHasta" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <button onclick="aplicarFiltros()" class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white px-4 py-2 rounded-md font-semibold transition">
                        <i class="fas fa-filter mr-2"></i>Filtrar
                    </button>
                    <button onclick="limpiarFiltros()" class="text-sm text-gray-600 hover:text-gray-800 underline">
                        Limpiar filtros
                    </button>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-semibold">Fecha y Hora</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold">Usuario</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold">Tabla</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold">Acción</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold">ID Registro</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold">IP</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaCambios" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="text-center py-10 text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-3"></i>
                                    <p>Cargando cambios...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <div id="paginationControls" class="mt-6 bg-white rounded-lg shadow-md p-4 hidden">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                        <div id="paginationSummary" class="text-sm text-gray-700"></div>
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-700">Mostrar:</label>
                            <select id="cambiosPorPagina" class="px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm">
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span class="text-sm text-gray-700">por página</span>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                        <div id="paginationInfo" class="text-sm text-gray-700"></div>
                        <div class="flex gap-2">
                            <button id="prevPageBtn" onclick="cambiarPagina(-1)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-left mr-1"></i>Anterior
                            </button>
                            <button id="nextPageBtn" onclick="cambiarPagina(1)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                Siguiente<i class="fas fa-chevron-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="footer-container"></div>

    <script>
        let cambios = [];
        let cambiosFiltrados = [];
        let cambiosPaginaActual = [];
        let paginaActual = 1;
        let CAMBIOS_POR_PAGINA = 10;
        let totalCambios = 0;
        let totalPaginas = 1;

        let paginationControls;
        let paginationSummary;
        let paginationInfo;
        let prevPageBtn;
        let nextPageBtn;
        let cambiosPorPaginaSelect;

        document.addEventListener('DOMContentLoaded', () => {
            loadNavbar();
            inicializarControlesPaginacion();
            cargarTablas();
            loadCambios();
            setupEventListeners();
        });

        function inicializarControlesPaginacion() {
            paginationControls = document.getElementById('paginationControls');
            paginationSummary = document.getElementById('paginationSummary');
            paginationInfo = document.getElementById('paginationInfo');
            prevPageBtn = document.getElementById('prevPageBtn');
            nextPageBtn = document.getElementById('nextPageBtn');
            cambiosPorPaginaSelect = document.getElementById('cambiosPorPagina');
            
            if (cambiosPorPaginaSelect) {
                cambiosPorPaginaSelect.addEventListener('change', function() {
                    CAMBIOS_POR_PAGINA = parseInt(this.value) || 20;
                    paginaActual = 1;
                    loadCambios();
                });
            }
        }

        function setupEventListeners() {
            const tablaFilter = document.getElementById('tablaFilter');
            const accionFilter = document.getElementById('accionFilter');
            if (tablaFilter) {
                tablaFilter.addEventListener('change', aplicarFiltros);
            }
            if (accionFilter) {
                accionFilter.addEventListener('change', aplicarFiltros);
            }
        }

        async function cargarTablas() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) return;

                const response = await fetch('/api/auditoria/tablas', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data.tablas) {
                        const select = document.getElementById('tablaFilter');
                        data.data.tablas.forEach(tabla => {
                            const option = document.createElement('option');
                            option.value = tabla;
                            option.textContent = tabla;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error al cargar tablas:', error);
            }
        }

        async function loadCambios() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No hay token de autenticación');
                }

                const userData = localStorage.getItem('userData');
                if (userData) {
                    const user = JSON.parse(userData);
                    if (user.tipoUsuario !== 'Administrador') {
                        Swal.fire({
                            icon: 'error',
                            title: 'Acceso Denegado',
                            text: 'No tienes permisos para acceder a esta página.'
                        });
                        return;
                    }
                }

                const tabla = document.getElementById('tablaFilter')?.value || '';
                const accion = document.getElementById('accionFilter')?.value || '';
                const fechaDesde = document.getElementById('fechaDesde')?.value || '';
                const fechaHasta = document.getElementById('fechaHasta')?.value || '';

                let url = '/api/auditoria?';
                const params = [];
                
                if (tabla) {
                    params.push(`tabla=${encodeURIComponent(tabla)}`);
                }
                if (accion) {
                    params.push(`accion=${encodeURIComponent(accion)}`);
                }
                if (fechaDesde) {
                    params.push(`fechaDesde=${encodeURIComponent(fechaDesde)}`);
                }
                if (fechaHasta) {
                    params.push(`fechaHasta=${encodeURIComponent(fechaHasta)}`);
                }

                params.push(`limit=${CAMBIOS_POR_PAGINA}`);
                params.push(`offset=${(paginaActual - 1) * CAMBIOS_POR_PAGINA}`);

                if (params.length > 0) {
                    url += params.join('&');
                } else {
                    url = url.slice(0, -1);
                }

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { message: errorText || 'Error desconocido' };
                    }
                    throw new Error(errorData.message || 'No se pudieron cargar los cambios');
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'No se pudieron cargar los cambios');
                }

                cambios = data.data?.cambios || [];
                totalCambios = data.data?.paginacion?.total || 0;
                totalPaginas = data.data?.paginacion?.totalPaginas || 1;
                
                renderCambios();
                renderizarControlesPaginacion();
            } catch (error) {
                console.error('Error al cargar cambios:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'No se pudieron cargar los cambios'
                });
                document.getElementById('tablaCambios').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-10 text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
                            <p class="text-lg font-medium">Error al cargar los cambios</p>
                            <p class="text-sm">${error.message || 'No se pudieron cargar los cambios'}</p>
                        </td>
                    </tr>
                `;
            }
        }

        function renderCambios() {
            const tbody = document.getElementById('tablaCambios');
            
            if (cambios.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-10 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i>
                            <p class="text-lg font-medium">No se encontraron cambios</p>
                            <p class="text-gray-500">No hay registros de auditoría con los filtros seleccionados.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = cambios.map(cambio => {
                const fecha = new Date(cambio.fecha_cambio);
                const fechaFormateada = fecha.toLocaleDateString('es-CR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                const horaFormateada = fecha.toLocaleTimeString('es-CR', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-700">
                            <div>${fechaFormateada}</div>
                            <div class="text-gray-500">${horaFormateada}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="font-semibold text-gray-800">${cambio.usuario_nombre || 'N/A'}</div>
                            <div class="text-sm text-gray-500">${cambio.usuario_correo || ''}</div>
                            ${cambio.usuario_rol ? `<div class="text-xs text-gray-400">${cambio.usuario_rol}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-700">
                            <span class="font-mono bg-gray-100 px-2 py-1 rounded">${cambio.tabla_afectada}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="accion-badge ${getAccionBadgeClass(cambio.accion_realizada)}">
                                ${formatAccion(cambio.accion_realizada)}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-700">
                            ${cambio.id_registro_afectado || '-'}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-700">
                            ${cambio.ip_usuario || '-'}
                        </td>
                        <td class="px-6 py-4 text-center">
                            <button onclick="verDetallesCambio(${cambio.id_cambio})" class="text-orange-600 hover:text-orange-700 font-semibold">
                                <i class="fas fa-eye mr-1"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getAccionBadgeClass(accion) {
            switch(accion?.toUpperCase()) {
                case 'CREATE':
                    return 'accion-create';
                case 'UPDATE':
                    return 'accion-update';
                case 'DELETE':
                    return 'accion-delete';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function formatAccion(accion) {
            switch(accion?.toUpperCase()) {
                case 'CREATE':
                    return 'Crear';
                case 'UPDATE':
                    return 'Actualizar';
                case 'DELETE':
                    return 'Eliminar';
                default:
                    return accion || 'N/A';
            }
        }

        function renderizarControlesPaginacion() {
            if (totalCambios === 0) {
                if (paginationControls) paginationControls.classList.add('hidden');
                return;
            }

            if (paginationControls) paginationControls.classList.remove('hidden');

            if (paginationSummary) {
                const inicio = totalCambios > 0 ? (paginaActual - 1) * CAMBIOS_POR_PAGINA + 1 : 0;
                const fin = Math.min(paginaActual * CAMBIOS_POR_PAGINA, totalCambios);
                paginationSummary.textContent = `Mostrando ${inicio}-${fin} de ${totalCambios} cambios`;
            }

            if (paginationInfo) {
                paginationInfo.textContent = `Página ${paginaActual} de ${totalPaginas}`;
            }

            if (prevPageBtn) {
                prevPageBtn.disabled = paginaActual <= 1;
            }

            if (nextPageBtn) {
                nextPageBtn.disabled = paginaActual >= totalPaginas;
            }

            // Sincronizar el selector de cambios por página
            if (cambiosPorPaginaSelect) {
                cambiosPorPaginaSelect.value = CAMBIOS_POR_PAGINA;
            }
        }

        function aplicarFiltros() {
            paginaActual = 1;
            loadCambios();
        }

        function limpiarFiltros() {
            document.getElementById('tablaFilter').value = '';
            document.getElementById('accionFilter').value = '';
            document.getElementById('fechaDesde').value = '';
            document.getElementById('fechaHasta').value = '';
            paginaActual = 1;
            loadCambios();
        }

        function cambiarPagina(offset) {
            const nuevaPagina = paginaActual + offset;
            if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
                paginaActual = nuevaPagina;
                loadCambios();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        async function verDetallesCambio(idCambio) {
            try {
                const cambio = cambios.find(c => c.id_cambio === idCambio);
                if (!cambio) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Cambio no encontrado'
                    });
                    return;
                }

                const fecha = new Date(cambio.fecha_cambio);
                const fechaFormateada = fecha.toLocaleString('es-CR');

                let detallesHTML = `
                    <div class="text-left space-y-4">
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-2">Información General</h3>
                            <div class="bg-gray-50 p-3 rounded space-y-2">
                                <p><span class="font-medium">Fecha y Hora:</span> ${fechaFormateada}</p>
                                <p><span class="font-medium">Usuario:</span> ${cambio.usuario_nombre || 'N/A'} (${cambio.usuario_correo || 'N/A'})</p>
                                <p><span class="font-medium">Rol:</span> ${cambio.usuario_rol || 'N/A'}</p>
                                <p><span class="font-medium">Tabla:</span> <span class="font-mono bg-gray-200 px-2 py-1 rounded">${cambio.tabla_afectada}</span></p>
                                <p><span class="font-medium">Acción:</span> <span class="accion-badge ${getAccionBadgeClass(cambio.accion_realizada)}">${formatAccion(cambio.accion_realizada)}</span></p>
                                <p><span class="font-medium">ID Registro:</span> ${cambio.id_registro_afectado || 'N/A'}</p>
                                <p><span class="font-medium">IP:</span> ${cambio.ip_usuario || 'N/A'}</p>
                            </div>
                        </div>
                `;

                if (cambio.datos_anteriores || cambio.datos_nuevos) {
                    detallesHTML += `
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-2">Datos</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    `;

                    if (cambio.datos_anteriores) {
                        detallesHTML += `
                            <div>
                                <h4 class="font-medium text-red-600 mb-2">Datos Anteriores:</h4>
                                <pre class="bg-red-50 p-3 rounded text-xs overflow-auto max-h-48">${JSON.stringify(cambio.datos_anteriores, null, 2)}</pre>
                            </div>
                        `;
                    }

                    if (cambio.datos_nuevos) {
                        detallesHTML += `
                            <div>
                                <h4 class="font-medium text-green-600 mb-2">Datos Nuevos:</h4>
                                <pre class="bg-green-50 p-3 rounded text-xs overflow-auto max-h-48">${JSON.stringify(cambio.datos_nuevos, null, 2)}</pre>
                            </div>
                        `;
                    }

                    detallesHTML += `
                            </div>
                        </div>
                    `;
                }

                detallesHTML += `</div>`;

                Swal.fire({
                    title: 'Detalles del Cambio',
                    html: detallesHTML,
                    width: '90%',
                    maxWidth: '800px',
                    confirmButtonText: 'Cerrar',
                    confirmButtonColor: '#f97316'
                });
            } catch (error) {
                console.error('Error al obtener detalles:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudieron cargar los detalles del cambio'
                });
            }
        }

        window.cambiarPagina = cambiarPagina;
    </script>
</body>
</html>

